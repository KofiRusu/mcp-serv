<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatOS</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">‚ö°</span>
                    <span class="logo-text">ChatOS</span>
                </div>
                <span class="version">v0.1</span>
            </div>

            <!-- Scrollable Content Area -->
            <div class="sidebar-content">
            <!-- Command Palette -->
            <div class="sidebar-section">
                <h3 class="section-title">Commands</h3>
                <div class="command-list" id="command-list">
                    <div class="command-item" data-command="research" onclick="insertCommand('research')">
                        <span class="command-icon">üî¨</span>
                        <div class="command-info">
                            <span class="command-name">/research</span>
                            <span class="command-desc">Deep web research</span>
                        </div>
                    </div>
                    <div class="command-item" data-command="deepthinking" onclick="insertCommand('deepthinking')">
                        <span class="command-icon">üß†</span>
                        <div class="command-info">
                            <span class="command-name">/deepthinking</span>
                            <span class="command-desc">Chain-of-thought</span>
                        </div>
                    </div>
                    <div class="command-item" data-command="swarm" onclick="insertCommand('swarm')">
                        <span class="command-icon">üêù</span>
                        <div class="command-info">
                            <span class="command-name">/swarm</span>
                            <span class="command-desc">Multi-agent coding</span>
                        </div>
                    </div>
                    <div class="command-item" data-command="code" onclick="insertCommand('code')">
                        <span class="command-icon">‚å®Ô∏è</span>
                        <div class="command-info">
                            <span class="command-name">/code</span>
                            <span class="command-desc">Code generation</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="section-title">Council Models</h3>
                <div id="model-list" class="model-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="section-title">Strategy</h3>
                <div class="strategy-badge" id="strategy-display">
                    <span class="strategy-icon">üéØ</span>
                    <span>Longest wins</span>
                </div>
            </div>

            <div class="sidebar-section settings-section">
                <h3 class="section-title">Settings</h3>
                
                <!-- Quick Toggle -->
                <div class="setting-item">
                    <label class="toggle-label">
                        <input type="checkbox" id="use-rag" checked>
                        <span class="toggle-switch"></span>
                        <span>Use RAG</span>
                    </label>
                </div>

                <!-- Settings Sub-Menu -->
                <div class="settings-menu">
                    <a href="/settings#providers" class="settings-menu-item">
                        <span class="settings-icon">üîå</span>
                        <span>Providers</span>
                    </a>
                    <a href="/settings#models" class="settings-menu-item">
                        <span class="settings-icon">ü§ñ</span>
                        <span>Models</span>
                    </a>
                    <a href="/settings#council" class="settings-menu-item">
                        <span class="settings-icon">üë•</span>
                        <span>Council</span>
                    </a>
                    <a href="/settings#api-keys" class="settings-menu-item">
                        <span class="settings-icon">üîë</span>
                        <span>API Keys</span>
                    </a>
                    <a href="/settings#general" class="settings-menu-item">
                        <span class="settings-icon">‚öôÔ∏è</span>
                        <span>General</span>
                    </a>
                </div>
            </div>
            </div><!-- End sidebar-content -->

            <div class="sidebar-footer">
                <a href="/projects" class="btn btn-primary btn-small sidebar-btn">
                    üì¶ Projects
                </a>
                <a href="/sandbox" class="btn btn-secondary btn-small sidebar-btn">
                    üíª Sandbox
                </a>
                <button class="btn btn-secondary btn-small" onclick="clearChat()">
                    üóëÔ∏è Clear Chat
                </button>
                <div class="health-indicator" id="health-indicator">
                    <span class="health-dot"></span>
                    <span>Connecting...</span>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div class="chat-header">
                <h1>Council Chat</h1>
                <p class="chat-subtitle">Multiple models. One answer. Use /commands for special modes.</p>
            </div>

            <div class="chat-container" id="chat-container">
                <div class="welcome-message" id="welcome-message">
                    <div class="welcome-icon">ü§ñ</div>
                    <h2>Welcome to ChatOS</h2>
                    <p>Start a conversation with your local AI council, or use special commands for advanced features.</p>
                    <div class="welcome-tips">
                        <div class="tip">
                            <span class="tip-icon">üî¨</span>
                            <span><strong>/research</strong> - Deep research with web context</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üß†</span>
                            <span><strong>/deepthinking</strong> - Extended chain-of-thought</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üêù</span>
                            <span><strong>/swarm</strong> - Multi-agent coding collaboration</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üíª</span>
                            <span><strong>Sandbox</strong> - Full coding environment</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <!-- Model selector bar -->
                <div class="model-selector-bar">
                    <div class="model-selector-wrapper">
                        <label for="model-selector" class="model-selector-label">Model:</label>
                        <select id="model-selector" class="model-selector" onchange="onModelSelect(this)">
                            <option value="">üèõÔ∏è Council (All Models)</option>
                        </select>
                    </div>
                    <span id="model-mode-indicator" class="model-mode-indicator">Council Mode</span>
                </div>
                
                <!-- Attachment preview -->
                <div id="attachment-preview" class="attachment-preview" style="display: none;">
                    <div id="attachment-list" class="attachment-list"></div>
                </div>
                
                <form id="chat-form" onsubmit="return handleSubmit(event)" action="javascript:void(0);">
                    <div class="input-wrapper">
                        <button type="button" class="attach-button" onclick="triggerFileUpload()" title="Attach file">
                            üìé
                        </button>
                        <textarea 
                            id="message-input" 
                            placeholder="Type your message or /command... (Shift+Enter for new line)"
                            rows="1"
                            autofocus
                        ></textarea>
                        <button type="button" class="send-button" id="send-button" onclick="handleSubmit(event)">
                            <span class="send-icon">‚û§</span>
                        </button>
                    </div>
                    <div class="input-hints" id="input-hints"></div>
                </form>
                
                <!-- Hidden file input -->
                <input type="file" id="file-input" style="display: none;" 
                       accept=".py,.js,.ts,.tsx,.jsx,.html,.css,.json,.yaml,.yml,.txt,.md,.sh,.sql"
                       multiple onchange="handleFileSelect(event)">
            </div>
        </main>
    </div>

    <script>
        // =============================================================================
        // State
        // =============================================================================
        
        let isLoading = false;
        let councilInfo = null;
        let commandSuggestions = [];
        let attachments = [];  // Current attachments
        let sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        let availableModels = [];  // All enabled models (not just council)
        let selectedModelId = null;  // null = use council, string = use specific model

        // =============================================================================
        // Initialization
        // =============================================================================
        
        // =============================================================================
        //  Window Size Auto-Detection
        // =============================================================================
        
        const BREAKPOINTS = {
            compact: 900,
            medium: 1100,
            large: 1400,
            xlarge: 1600
        };
        
        let currentSize = 'large';
        
        function detectWindowSize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            // Determine size category
            let newSize;
            if (width < BREAKPOINTS.compact) {
                newSize = 'compact';
            } else if (width < BREAKPOINTS.medium) {
                newSize = 'medium';
            } else if (width < BREAKPOINTS.large) {
                newSize = 'large';
            } else {
                newSize = 'xlarge';
            }
            
            // Update body class for CSS targeting
            if (newSize !== currentSize) {
                document.body.classList.remove('size-compact', 'size-medium', 'size-large', 'size-xlarge');
                document.body.classList.add(`size-${newSize}`);
                currentSize = newSize;
                console.log(`Window size: ${width}x${height} (${newSize})`);
            }
            
            return { width, height, size: newSize };
        }
        
        // Debounce for performance
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
        
        // Listen for resize
        window.addEventListener('resize', debounce(detectWindowSize, 100));

        document.addEventListener('DOMContentLoaded', () => {
            // Initial size detection
            detectWindowSize();
            
            loadCouncilInfo();
            loadAvailableModels();
            checkHealth();
            setupTextarea();
            setInterval(checkHealth, 30000);
        });

        // =============================================================================
        // API Calls
        // =============================================================================
        
        async function loadCouncilInfo() {
            try {
                const response = await fetch('/api/council');
                councilInfo = await response.json();
                updateStrategyDisplay(councilInfo.strategy);
            } catch (error) {
                console.error('Failed to load council info:', error);
            }
        }

        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/models?enabled_only=true');
                availableModels = await response.json();
                renderModelSelector(availableModels);
                renderModelList(availableModels);
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        async function checkHealth() {
            const indicator = document.getElementById('health-indicator');
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                if (data.status === 'healthy') {
                    indicator.innerHTML = `
                        <span class="health-dot healthy"></span>
                        <span>${data.models_loaded} models ‚Ä¢ ${data.rag_documents} docs</span>
                    `;
                }
            } catch (error) {
                indicator.innerHTML = `
                    <span class="health-dot error"></span>
                    <span>Connection error</span>
                `;
            }
        }

        async function sendMessage(message, useRag) {
            const attachmentIds = attachments.map(a => a.id);
            
            // Use AbortController for timeout (5 minutes for complex LLM queries)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minutes
            
            try {
                const requestBody = {
                    message: message,
                    mode: 'normal',
                    use_rag: useRag,
                    session_id: sessionId,
                    attachment_ids: attachmentIds.length > 0 ? attachmentIds : null,
                };
                
                // Add model_id if a specific model is selected
                if (selectedModelId) {
                    requestBody.model_id = selectedModelId;
                }
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal,
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Clear attachments after sending
                attachments = [];
                renderAttachmentPreview();

                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. The model is taking too long to respond.');
                }
                throw error;
            }
        }

        // =============================================================================
        // File Attachments
        // =============================================================================
        
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (const file of files) {
                await uploadFile(file);
            }
            
            event.target.value = '';  // Reset input
        }

        async function uploadFile(file) {
            // Check size
            if (file.size > 10 * 1024 * 1024) {
                alert('File too large. Max 10MB.');
                return;
            }
            
            // Read as base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                
                try {
                    const response = await fetch('/api/attachments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: file.name,
                            content_base64: base64,
                            session_id: sessionId,
                        }),
                    });
                    
                    if (response.ok) {
                        const attachment = await response.json();
                        attachments.push(attachment);
                        renderAttachmentPreview();
                    } else {
                        const err = await response.json();
                        alert('Upload failed: ' + err.detail);
                    }
                } catch (e) {
                    alert('Upload failed: ' + e.message);
                }
            };
            reader.readAsDataURL(file);
        }

        function renderAttachmentPreview() {
            const container = document.getElementById('attachment-preview');
            const list = document.getElementById('attachment-list');
            
            if (attachments.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = attachments.map((a, i) => `
                <div class="attachment-item">
                    <span class="attachment-icon">${getFileIcon(a.original_filename)}</span>
                    <span class="attachment-name">${a.original_filename}</span>
                    <span class="attachment-size">${formatFileSize(a.size)}</span>
                    <button class="attachment-remove" onclick="removeAttachment(${i})">√ó</button>
                </div>
            `).join('');
        }

        function removeAttachment(index) {
            attachments.splice(index, 1);
            renderAttachmentPreview();
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'py': 'üêç', 'js': 'üìú', 'ts': 'üìò', 'json': 'üìã',
                'html': 'üåê', 'css': 'üé®', 'md': 'üìù', 'txt': 'üìÑ',
                'sh': '‚öôÔ∏è', 'sql': 'üóÉÔ∏è',
            };
            return icons[ext] || 'üìé';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // =============================================================================
        // UI Rendering
        // =============================================================================
        
        function renderModelList(models) {
            const container = document.getElementById('model-list');
            // Filter to show only real models (not dummy) in the sidebar
            const realModels = models.filter(m => m.provider !== 'dummy');
            container.innerHTML = realModels.map(model => `
                <div class="model-item ${model.is_council_member ? 'council-member' : ''}" 
                     data-model="${model.name}" 
                     data-model-id="${model.id}"
                     onclick="selectModelFromSidebar('${model.id}')">
                    <span class="model-icon">${getProviderIcon(model.provider)}</span>
                    <div class="model-info">
                        <span class="model-name">${model.name}</span>
                        <span class="model-behavior">${model.model_id}</span>
                    </div>
                    ${model.is_council_member ? '<span class="council-badge">üë•</span>' : ''}
                </div>
            `).join('');
        }

        function renderModelSelector(models) {
            const selector = document.getElementById('model-selector');
            if (!selector) return;
            
            // Filter to real models only
            const realModels = models.filter(m => m.provider !== 'dummy');
            
            let options = '<option value="">üèõÔ∏è Council (All Models)</option>';
            realModels.forEach(model => {
                const icon = getProviderIcon(model.provider);
                options += `<option value="${model.id}">${icon} ${model.name}</option>`;
            });
            
            selector.innerHTML = options;
        }

        function selectModelFromSidebar(modelId) {
            selectedModelId = modelId;
            const selector = document.getElementById('model-selector');
            if (selector) {
                selector.value = modelId;
            }
            updateModelSelectionUI();
        }

        function onModelSelect(selectElement) {
            selectedModelId = selectElement.value || null;
            updateModelSelectionUI();
        }

        function updateModelSelectionUI() {
            // Update sidebar highlighting
            document.querySelectorAll('.model-item').forEach(el => {
                el.classList.remove('selected');
                if (selectedModelId && el.dataset.modelId === selectedModelId) {
                    el.classList.add('selected');
                }
            });
            
            // Update the indicator text
            const indicator = document.getElementById('model-mode-indicator');
            if (indicator) {
                if (selectedModelId) {
                    const model = availableModels.find(m => m.id === selectedModelId);
                    indicator.textContent = model ? `Using: ${model.name}` : 'Single Model';
                    indicator.classList.add('single-mode');
                } else {
                    indicator.textContent = 'Council Mode';
                    indicator.classList.remove('single-mode');
                }
            }
        }

        function getProviderIcon(provider) {
            const icons = {
                'ollama': 'ü¶ô',
                'openai': 'ü§ñ',
                'anthropic': 'üß†',
                'google': 'üîÆ',
                'lm_studio': 'üíª',
                'groq': '‚ö°',
                'dummy': 'üé≠',
            };
            return icons[provider] || 'ü§ñ';
        }

        function getModelIcon(behavior) {
            const icons = {
                'thoughtful': 'üß†',
                'concise': '‚ö°',
                'creative': 'üé®',
                'analytical': 'üìä',
            };
            return icons[behavior] || 'ü§ñ';
        }

        function getModeIcon(mode) {
            const icons = {
                'research': 'üî¨',
                'deepthinking': 'üß†',
                'swarm': 'üêù',
                'code': '‚å®Ô∏è',
                'normal': 'üí¨',
            };
            return icons[mode] || 'üí¨';
        }

        function updateStrategyDisplay(strategy) {
            const display = document.getElementById('strategy-display');
            const strategies = {
                'longest': { icon: 'üìè', text: 'Longest wins' },
                'shortest': { icon: '‚úÇÔ∏è', text: 'Shortest wins' },
                'random': { icon: 'üé≤', text: 'Random selection' },
                'first': { icon: '1Ô∏è‚É£', text: 'First response' },
            };
            const info = strategies[strategy] || strategies['longest'];
            display.innerHTML = `
                <span class="strategy-icon">${info.icon}</span>
                <span>${info.text}</span>
            `;
        }

        function hideWelcomeMessage() {
            const welcome = document.getElementById('welcome-message');
            if (welcome) welcome.style.display = 'none';
        }

        function appendUserMessage(text) {
            hideWelcomeMessage();
            const container = document.getElementById('chat-container');
            const isCommand = text.startsWith('/');
            const messageEl = document.createElement('div');
            messageEl.className = 'message user-message';
            messageEl.innerHTML = `
                <div class="message-content">
                    <div class="message-text ${isCommand ? 'command-text' : ''}">${escapeHtml(text)}</div>
                </div>
                <div class="message-avatar user-avatar">You</div>
            `;
            container.appendChild(messageEl);
            scrollToBottom();
        }

        function appendAssistantMessage(data) {
            const container = document.getElementById('chat-container');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant-message';
            
            // Safely extract data with defaults
            const answer = data?.answer || 'No response received';
            const chosenModel = data?.chosen_model || 'Unknown';
            const responses = data?.responses || [];
            const mode = data?.mode || 'normal';
            const memorySummary = data?.memory_summary || '';
            
            // Determine if this was a single model or council response
            const isSingleModel = responses.length <= 1;
            const responseModeBadge = isSingleModel 
                ? '<span class="response-mode-badge single">üéØ Single</span>'
                : '<span class="response-mode-badge council">üèõÔ∏è Council</span>';
            
            const formattedAnswer = formatResponse(answer);
            const modeIcon = isSingleModel ? 'üéØ' : getModeIcon(mode);
            const modeBadge = data?.command ? `<span class="mode-badge">${getModeIcon(mode)} /${data.command}</span>` : '';
            
            const responsesHtml = responses.map(r => `
                <div class="model-response ${r.model === chosenModel ? 'chosen' : ''}">
                    <div class="model-response-header">
                        <span class="model-response-name">${escapeHtml(r.model || 'Unknown')}</span>
                        ${r.model === chosenModel ? '<span class="chosen-badge">‚úì Chosen</span>' : ''}
                    </div>
                    <div class="model-response-text">${escapeHtml(r.text || '')}</div>
                </div>
            `).join('');

            messageEl.innerHTML = `
                <div class="message-avatar assistant-avatar">${modeIcon}</div>
                <div class="message-content">
                    <div class="message-meta">
                        ${responseModeBadge}
                        <span class="chosen-model">${escapeHtml(chosenModel)}</span>
                        ${modeBadge}
                        <span class="meta-separator">‚Ä¢</span>
                        <span class="memory-summary">${escapeHtml(memorySummary)}</span>
                    </div>
                    <div class="message-text">${formattedAnswer}</div>
                    ${responses.length > 1 ? `
                    <details class="responses-details">
                        <summary class="responses-summary">
                            <span>Show all ${responses.length} council responses</span>
                            <span class="expand-icon">‚ñº</span>
                        </summary>
                        <div class="responses-list">${responsesHtml}</div>
                    </details>
                    ` : ''}
                </div>
            `;
            container.appendChild(messageEl);
            highlightChosenModel(chosenModel);
            scrollToBottom();
        }

        function appendLoadingMessage(mode = 'normal') {
            const container = document.getElementById('chat-container');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message assistant-message loading-message';
            loadingEl.id = 'loading-message';
            
            // Determine loading text based on mode AND model selection
            let modeText;
            let avatarIcon;
            
            if (selectedModelId) {
                // Single model mode
                const model = availableModels.find(m => m.id === selectedModelId);
                const modelName = model ? model.name : 'Model';
                modeText = {
                    'research': 'Researching...',
                    'deepthinking': 'Thinking deeply...',
                    'swarm': 'Swarm collaborating...',
                    'code': `${modelName} is coding...`,
                    'normal': `${modelName} is thinking...`,
                }[mode] || `${modelName} is processing...`;
                avatarIcon = 'üéØ';
            } else {
                // Council mode
                modeText = {
                    'research': 'Researching...',
                    'deepthinking': 'Thinking deeply...',
                    'swarm': 'Swarm collaborating...',
                    'code': 'Council is generating code...',
                    'normal': 'Council is deliberating...',
                }[mode] || 'Processing...';
                avatarIcon = getModeIcon(mode);
            }
            
            loadingEl.innerHTML = `
                <div class="message-avatar assistant-avatar">${avatarIcon}</div>
                <div class="message-content">
                    <div class="loading-indicator">
                        <span class="loading-dot"></span>
                        <span class="loading-dot"></span>
                        <span class="loading-dot"></span>
                        <span class="loading-text">${modeText}</span>
                    </div>
                </div>
            `;
            container.appendChild(loadingEl);
            scrollToBottom();
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loading-message');
            if (loading) loading.remove();
        }

        function appendErrorMessage(error) {
            const container = document.getElementById('chat-container');
            const messageEl = document.createElement('div');
            messageEl.className = 'message error-message';
            messageEl.innerHTML = `
                <div class="message-avatar error-avatar">‚ö†Ô∏è</div>
                <div class="message-content">
                    <div class="message-text">Error: ${escapeHtml(error)}</div>
                </div>
            `;
            container.appendChild(messageEl);
            scrollToBottom();
        }

        function highlightChosenModel(modelName) {
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('chosen'));
            const chosenEl = document.querySelector(`.model-item[data-model="${modelName}"]`);
            if (chosenEl) chosenEl.classList.add('chosen');
        }

        function highlightCommand(command) {
            document.querySelectorAll('.command-item').forEach(el => el.classList.remove('active'));
            if (command) {
                const cmdEl = document.querySelector(`.command-item[data-command="${command}"]`);
                if (cmdEl) cmdEl.classList.add('active');
            }
        }

        // =============================================================================
        // Event Handlers
        // =============================================================================
        
        async function handleSubmit(event) {
            // Prevent form submission / page refresh
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (isLoading) return false;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return false;
            
            const useRag = document.getElementById('use-rag')?.checked ?? true;
            
            // Detect mode from message
            let mode = 'normal';
            if (message.startsWith('/research')) mode = 'research';
            else if (message.startsWith('/deepthinking')) mode = 'deepthinking';
            else if (message.startsWith('/swarm')) mode = 'swarm';
            else if (message.startsWith('/code')) mode = 'code';
            
            input.value = '';
            resetTextareaHeight();
            hideInputHints();
            appendUserMessage(message);
            highlightCommand(mode !== 'normal' ? mode : null);
            
            isLoading = true;
            updateSendButton(true);
            appendLoadingMessage(mode);
            
            try {
                const data = await sendMessage(message, useRag);
                removeLoadingMessage();
                appendAssistantMessage(data);
            } catch (error) {
                console.error('Chat error:', error);
                removeLoadingMessage();
                appendErrorMessage(error.message || 'An error occurred');
            } finally {
                isLoading = false;
                updateSendButton(false);
                highlightCommand(null);
            }
            
            return false; // Prevent form submission
        }

        function insertCommand(command) {
            const input = document.getElementById('message-input');
            input.value = `/${command} `;
            input.focus();
            showInputHints(command);
        }

        function clearChat() {
            const container = document.getElementById('chat-container');
            container.innerHTML = `
                <div class="welcome-message" id="welcome-message">
                    <div class="welcome-icon">ü§ñ</div>
                    <h2>Welcome to ChatOS</h2>
                    <p>Start a conversation with your local AI council.</p>
                </div>
            `;
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('chosen'));
        }

        // =============================================================================
        // Utilities
        // =============================================================================
        
        function setupTextarea() {
            const textarea = document.getElementById('message-input');
            
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
                
                // Check for command hints
                const value = textarea.value;
                if (value.startsWith('/')) {
                    const cmd = value.slice(1).split(' ')[0];
                    showInputHints(cmd);
                } else {
                    hideInputHints();
                }
            });
            
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleSubmit(e);
                }
                if (e.key === 'Escape') {
                    textarea.value = '';
                    resetTextareaHeight();
                    hideInputHints();
                }
            });
        }

        function showInputHints(command) {
            const hints = document.getElementById('input-hints');
            const hintText = {
                'research': 'üî¨ Research: Add your query to search the web for context',
                'deepthinking': 'üß† Deep Thinking: Add a problem to analyze with extended reasoning',
                'swarm': 'üêù Swarm: Describe a coding task for multi-agent collaboration',
                'code': '‚å®Ô∏è Code: Add your coding request',
            }[command];
            
            if (hintText) {
                hints.textContent = hintText;
                hints.style.display = 'block';
            } else {
                hints.style.display = 'none';
            }
        }

        function hideInputHints() {
            document.getElementById('input-hints').style.display = 'none';
        }

        function resetTextareaHeight() {
            const textarea = document.getElementById('message-input');
            textarea.style.height = 'auto';
        }

        function updateSendButton(loading) {
            const button = document.getElementById('send-button');
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<span class="send-icon spinning">‚Üª</span>';
            } else {
                button.disabled = false;
                button.innerHTML = '<span class="send-icon">‚û§</span>';
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatResponse(text) {
            let formatted = escapeHtml(text);
            
            // Convert markdown headers
            formatted = formatted.replace(/^### (.+)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^# (.+)$/gm, '<h2>$1</h2>');
            
            // Convert bold
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert code blocks
            formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre class="code-block"><code class="language-${lang || 'plaintext'}">${code.trim()}</code></pre>`;
            });
            
            // Convert inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            // Convert bullet points
            formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // Convert checkboxes
            formatted = formatted.replace(/\[x\]/g, '‚úÖ');
            formatted = formatted.replace(/\[ \]/g, '‚¨ú');
            
            // Convert line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
    </script>
</body>
</html>
