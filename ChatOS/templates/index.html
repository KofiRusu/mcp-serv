<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatOS</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* =============================================================================
           ChatGPT-Style Sidebar Layout
           ============================================================================= */
        
        .app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Chat Sidebar - Left Panel */
        .chat-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 250;  /* Higher than top-nav (200) */
        }
        
        .chat-sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        .chat-sidebar-header {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-toggle-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s;
        }
        
        .sidebar-toggle-btn:hover {
            background: var(--bg-tertiary);
        }
        
        .new-chat-btn {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .new-chat-btn:hover {
            background: var(--bg-tertiary);
        }
        
        /* Chat List */
        .chat-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .chat-list-section {
            margin-bottom: 8px;
        }
        
        .chat-list-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .chat-list-section-header:hover {
            background: var(--bg-tertiary);
        }
        
        .chat-list-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .chat-list-section-toggle {
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }
        
        .chat-list-section.collapsed .chat-list-section-toggle {
            transform: rotate(-90deg);
        }
        
        .chat-list-section.collapsed .chat-list-section-content {
            display: none;
        }
        
        .chat-list-section-content {
            padding-left: 4px;
        }
        
        .chat-list-section-count {
            font-size: 10px;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }
        
        .chat-list-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            margin-bottom: 2px;
        }
        
        .chat-list-item:hover {
            background: var(--bg-tertiary);
        }
        
        .chat-list-item.active {
            background: var(--bg-tertiary);
        }
        
        .chat-list-item-icon {
            font-size: 16px;
            opacity: 0.7;
        }
        
        .chat-list-item-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 14px;
        }
        
        .chat-list-item-project {
            font-size: 10px;
            color: var(--accent-primary);
            background: rgba(43, 38, 254, 0.15);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .chat-list-item-delete {
            display: none;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0.5;
            transition: opacity 0.2s, background 0.2s, color 0.2s;
            flex-shrink: 0;
        }
        
        .chat-list-item:hover .chat-list-item-delete {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-list-item-delete:hover {
            opacity: 1;
            background: rgba(255, 80, 80, 0.15);
            color: #ff5050;
        }
        
        .chat-list-clear {
            padding: 12px 8px;
            border-top: 1px solid var(--border-color);
            margin-top: 8px;
        }
        
        .clear-history-button {
            width: 100%;
            padding: 10px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .clear-history-button:hover {
            background: rgba(255, 80, 80, 0.1);
            border-color: rgba(255, 80, 80, 0.3);
            color: #ff5050;
        }
        
        /* Projects Button in Sidebar */
        .projects-button {
            margin: 8px;
            padding: 12px 16px;
            border: 1px dashed var(--border-color);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .projects-button:hover {
            background: var(--bg-tertiary);
            border-style: solid;
        }
        
        /* Sidebar Footer */
        .chat-sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .sidebar-footer-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: background 0.2s, color 0.2s;
        }
        
        .sidebar-footer-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        /* Top Navigation Bar */
        .top-nav {
            position: fixed;
            top: 0;
            left: 280px;  /* Start after sidebar */
            right: 0;
            height: 56px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 200;
            gap: 12px;
            transition: left 0.3s ease;
        }
        
        .chat-sidebar.collapsed ~ .top-nav,
        .chat-sidebar.collapsed + .chat-sidebar-overlay + .top-nav {
            left: 0;
        }
        
        .top-nav-toggle {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 20px;
        }
        
        .chat-sidebar.collapsed ~ .chat-main .top-nav-toggle,
        .top-nav-toggle.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .top-nav-toggle:hover {
            background: var(--bg-tertiary);
        }
        
        .top-nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .top-nav-brand .logo-icon {
            font-size: 20px;
        }
        
        /* Navigation Dropdown */
        .nav-dropdown {
            position: relative;
        }
        
        .nav-dropdown-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .nav-dropdown-btn:hover {
            background: var(--bg-tertiary);
        }
        
        .nav-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            min-width: 200px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 300;
        }
        
        .nav-dropdown-menu.open {
            display: block;
        }
        
        .nav-dropdown-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-primary);
            text-decoration: none;
            transition: background 0.2s;
        }
        
        .nav-dropdown-item:hover {
            background: var(--bg-tertiary);
        }
        
        .nav-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }
        
        /* Main Chat Area Adjustment */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            padding-top: 56px; /* Account for fixed top nav */
            margin-left: 280px; /* Account for fixed sidebar */
            transition: margin-left 0.3s ease;
        }
        
        .chat-sidebar.collapsed ~ .chat-sidebar-overlay ~ nav ~ .chat-main,
        .chat-sidebar.collapsed + .chat-sidebar-overlay + nav + .chat-main {
            margin-left: 0;
        }
        
        /* Health indicator in top nav */
        .top-nav-health {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .top-nav-health .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }
        
        .top-nav-health.healthy .health-dot {
            background: var(--success);
        }
        
        /* Projects Modal */
        .projects-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }
        
        .projects-modal.open {
            display: flex;
        }
        
        .projects-modal-content {
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .projects-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .projects-modal-header h2 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .projects-modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            font-size: 20px;
        }
        
        .projects-modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .projects-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .project-card {
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }
        
        .project-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .project-card-icon {
            font-size: 24px;
        }
        
        .project-card-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .project-card-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .create-project-btn {
            width: 100%;
            padding: 16px;
            border: 2px dashed var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .create-project-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .chat-sidebar {
                z-index: 400;
            }
            
            .chat-sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 350;
                display: none;
            }
            
            .chat-sidebar:not(.collapsed) ~ .chat-sidebar-overlay {
                display: block;
            }
            
            .top-nav {
                left: 0 !important;
            }
            
            .chat-main {
                margin-left: 0 !important;
            }
            
            .top-nav-toggle {
                display: flex !important;
            }
        }
        
        /* Hide old sidebar styles */
        .sidebar.old-sidebar {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Chat Sidebar (ChatGPT-style) -->
        <aside class="chat-sidebar" id="chat-sidebar">
            <div class="chat-sidebar-header">
                <button class="sidebar-toggle-btn" onclick="toggleChatSidebar()" title="Close sidebar">‚ò∞</button>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span>‚úèÔ∏è</span>
                    <span>New chat</span>
                </button>
            </div>
            
            <div class="chat-list-container" id="chat-list-container">
                <!-- Chat history will be populated here -->
                <div class="chat-list-section" id="section-today">
                    <div class="chat-list-section-header" onclick="toggleSection('today')">
                        <div class="chat-list-section-title">
                            <span class="chat-list-section-toggle">‚ñº</span>
                            <span>Today</span>
                            <span class="chat-list-section-count" id="count-today">0</span>
                </div>
                </div>
                    <div class="chat-list-section-content" id="chat-list-today"></div>
                </div>
                <div class="chat-list-section" id="section-week">
                    <div class="chat-list-section-header" onclick="toggleSection('week')">
                        <div class="chat-list-section-title">
                            <span class="chat-list-section-toggle">‚ñº</span>
                            <span>Previous 7 Days</span>
                            <span class="chat-list-section-count" id="count-week">0</span>
                        </div>
                    </div>
                    <div class="chat-list-section-content" id="chat-list-week"></div>
                </div>
                <div class="chat-list-section" id="section-earlier">
                    <div class="chat-list-section-header" onclick="toggleSection('earlier')">
                        <div class="chat-list-section-title">
                            <span class="chat-list-section-toggle">‚ñº</span>
                            <span>Earlier</span>
                            <span class="chat-list-section-count" id="count-earlier">0</span>
                        </div>
                    </div>
                    <div class="chat-list-section-content" id="chat-list-earlier"></div>
                </div>
                
                <!-- Clear All History Button -->
                <div class="chat-list-clear" id="clear-history-btn" style="display: none;">
                    <button class="clear-history-button" onclick="clearAllHistory()">
                        <span>üóëÔ∏è</span>
                        <span>Clear All History</span>
                    </button>
                </div>
            </div>
            
            <button class="projects-button" onclick="openProjectsModal()">
                <span>üìÅ</span>
                <span>Projects</span>
                <span style="margin-left: auto; font-size: 12px; opacity: 0.6;" id="projects-count">0</span>
            </button>
            
            <div class="chat-sidebar-footer">
                <a href="/agi" class="sidebar-footer-item">
                    <span>ü§ñ</span>
                    <span>AGI Core</span>
                </a>
                <a href="/training" class="sidebar-footer-item">
                    <span>üß™</span>
                    <span>Training Lab</span>
                </a>
                <a href="/settings" class="sidebar-footer-item">
                    <span>‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </div>
        </aside>
        
        <!-- Overlay for mobile -->
        <div class="chat-sidebar-overlay" onclick="toggleChatSidebar()"></div>
        
        <!-- Top Navigation Bar -->
        <nav class="top-nav" id="top-nav">
            <button class="top-nav-toggle" id="top-nav-toggle" onclick="toggleChatSidebar()" title="Open sidebar">‚ò∞</button>
            
            <div class="top-nav-brand">
                <span class="logo-icon">‚ö°</span>
                <span>ChatOS</span>
            </div>
            
            <!-- Navigation Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-btn" onclick="toggleNavDropdown()">
                    <span>Menu</span>
                    <span>‚ñº</span>
                </button>
                <div class="nav-dropdown-menu" id="nav-dropdown-menu">
                    <a href="/agi" class="nav-dropdown-item">
                        <span>ü§ñ</span>
                        <span>AGI Core</span>
                    </a>
                    <a href="/training" class="nav-dropdown-item">
                        <span>üß™</span>
                        <span>Training Lab</span>
                    </a>
                    <a href="/history" class="nav-dropdown-item">
                        <span>üìú</span>
                        <span>Chat History</span>
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <a href="/sandbox" class="nav-dropdown-item">
                        <span>üíª</span>
                        <span>Sandbox</span>
                    </a>
                    <a href="/projects" class="nav-dropdown-item">
                        <span>üì¶</span>
                        <span>Code Projects</span>
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <a href="/settings" class="nav-dropdown-item">
                        <span>‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </div>
            </div>
            
            <!-- Model selector moved to top nav -->
            <div class="model-selector-wrapper" style="margin-left: 16px;">
                <select id="top-model-selector" class="model-selector" onchange="onModelSelect(this)" style="padding: 6px 10px; font-size: 13px;">
                    <option value="">üèõÔ∏è Council</option>
                </select>
            </div>
            
            <!-- RAG Toggle -->
            <label class="toggle-label" style="margin-left: 12px; font-size: 13px;">
                <input type="checkbox" id="use-rag" checked>
                <span class="toggle-switch" style="transform: scale(0.85);"></span>
                <span>RAG</span>
            </label>
            
            <!-- Health Indicator -->
            <div class="top-nav-health" id="health-indicator">
                <span class="health-dot"></span>
                <span>Connecting...</span>
            </div>
        </nav>
        
        <!-- Projects Modal -->
        <div class="projects-modal" id="projects-modal">
            <div class="projects-modal-content">
                <div class="projects-modal-header">
                    <h2>üìÅ Projects</h2>
                    <button class="projects-modal-close" onclick="closeProjectsModal()">√ó</button>
                </div>
                <div class="projects-modal-body" id="projects-modal-body">
                    <button class="create-project-btn" onclick="openProjectEditor()">
                        <span>‚ûï</span>
                        <span>Create New Project</span>
                    </button>
                    <div id="projects-list" style="margin-top: 16px;">
                        <!-- Projects will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Project Editor Modal -->
        <div class="projects-modal" id="project-editor-modal">
            <div class="projects-modal-content" style="max-width: 700px;">
                <div class="projects-modal-header">
                    <h2 id="editor-modal-title">‚ûï Create Project</h2>
                    <button class="projects-modal-close" onclick="closeProjectEditor()">√ó</button>
                </div>
                <div class="projects-modal-body" style="padding: 20px;">
                    <form id="project-form" onsubmit="return saveProject(event)">
                        <input type="hidden" id="edit-project-id" value="">
                        
                        <!-- Project Name -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Project Name</label>
                            <input type="text" id="project-name-input" placeholder="My Project" required
                                   style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;">
                        </div>
                        
                        <!-- Icon and Color -->
                        <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Icon</label>
                                <select id="project-icon-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;">
                                    <option value="üìÅ">üìÅ Folder</option>
                                    <option value="üíª">üíª Code</option>
                                    <option value="üìù">üìù Notes</option>
                                    <option value="üé®">üé® Design</option>
                                    <option value="üî¨">üî¨ Research</option>
                                    <option value="üìä">üìä Analytics</option>
                                    <option value="üöÄ">üöÄ Launch</option>
                                    <option value="‚ö°">‚ö° Quick</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Color</label>
                                <input type="color" id="project-color-input" value="#2B26FE"
                                       style="width: 100%; height: 44px; padding: 4px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); cursor: pointer;">
                            </div>
                        </div>
                        
                        <!-- System Instructions -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">System Instructions</label>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Define the AI's behavior for all chats in this project.</p>
                            <textarea id="project-instructions-input" rows="6" placeholder="You are a helpful assistant specialized in..."
                                      style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px; resize: vertical;"></textarea>
                        </div>
                        
                        <!-- File Upload -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; margin-bottom: 8px;">Knowledge Base Files</label>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Upload documents to give the AI context about your project.</p>
                            <div id="project-files-list" style="margin-bottom: 12px;"></div>
                            <label style="display: flex; align-items: center; justify-content: center; padding: 24px; border: 2px dashed var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="file" id="project-file-upload" multiple accept=".txt,.md,.pdf,.py,.js,.ts,.json,.yaml,.yml" style="display: none;" onchange="handleProjectFileUpload(event)">
                                <span style="color: var(--text-secondary);">üìé Drop files here or click to upload</span>
                            </label>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button type="button" onclick="closeProjectEditor()" style="padding: 10px 20px; border: 1px solid var(--border-color); border-radius: 8px; background: transparent; color: var(--text-primary); cursor: pointer;">Cancel</button>
                            <button type="submit" style="padding: 10px 20px; border: none; border-radius: 8px; background: var(--accent-primary); color: white; cursor: pointer; font-weight: 500;">Save Project</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div class="chat-container" id="chat-container">
                <div class="welcome-message" id="welcome-message">
                    <div class="welcome-icon">‚ö°</div>
                    <h2>Welcome to ChatOS</h2>
                    <p>Start a conversation or select a chat from the sidebar. Use /commands for special features.</p>
                    <div class="welcome-tips">
                        <div class="tip">
                            <span class="tip-icon">‚úèÔ∏è</span>
                            <span><strong>New Chat</strong> - Start fresh conversation</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üìÅ</span>
                            <span><strong>Projects</strong> - Organize chats with custom instructions</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üî¨</span>
                            <span><strong>/research</strong> - Deep web research</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üß†</span>
                            <span><strong>/deepthinking</strong> - Extended chain-of-thought</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üêù</span>
                            <span><strong>/swarm</strong> - Multi-agent coding collaboration</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <!-- Active Project Badge (shown when a project is selected) -->
                <div id="active-project-badge" class="active-project-badge" style="display: none;">
                    <span class="project-badge-icon" id="project-badge-icon">üìÅ</span>
                    <span class="project-badge-name" id="project-badge-name">Project</span>
                    <button class="project-badge-close" onclick="clearAIProject()" title="Clear project">√ó</button>
                </div>
                
                <!-- Attachment preview -->
                <div id="attachment-preview" class="attachment-preview" style="display: none;">
                    <div id="attachment-list" class="attachment-list"></div>
                </div>
                
                <form id="chat-form" onsubmit="return handleSubmit(event)" action="javascript:void(0);">
                    <div class="input-wrapper">
                        <button type="button" class="attach-button" onclick="triggerFileUpload()" title="Attach file">
                            üìé
                        </button>
                        <textarea 
                            id="message-input" 
                            placeholder="Type your message or /command... (Shift+Enter for new line)"
                            rows="1"
                            autofocus
                        ></textarea>
                        <button type="button" class="send-button" id="send-button" onclick="handleSubmit(event)">
                            <span class="send-icon">‚û§</span>
                        </button>
                    </div>
                    <div class="input-hints" id="input-hints"></div>
                </form>
                
                <!-- Hidden file input -->
                <input type="file" id="file-input" style="display: none;" 
                       accept=".py,.js,.ts,.tsx,.jsx,.html,.css,.json,.yaml,.yml,.txt,.md,.sh,.sql"
                       multiple onchange="handleFileSelect(event)">
            </div>
        </main>
    </div>

    <script>
        // =============================================================================
        // State
        // =============================================================================
        
        let isLoading = false;
        let councilInfo = null;
        let commandSuggestions = [];
        let attachments = [];  // Current attachments
        let chatHistory = [];  // Loaded chat history for sidebar
        let currentConversationId = null;  // Active conversation
        let sessionId = localStorage.getItem('chatos_session_id') || 'session_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('chatos_session_id', sessionId);
        let availableModels = [];  // All enabled models (not just council)
        let selectedModelId = null;  // null = use council, string = use specific model
        
        // AI Projects
        let aiProjects = [];  // Available AI projects
        let selectedAIProjectId = null;  // Currently selected AI project
        let selectedAIProject = null;  // Full project object

        // =============================================================================
        // Initialization
        // =============================================================================
        
        // =============================================================================
        //  Window Size Auto-Detection
        // =============================================================================
        
        const BREAKPOINTS = {
            compact: 900,
            medium: 1100,
            large: 1400,
            xlarge: 1600
        };
        
        let currentSize = 'large';
        
        function detectWindowSize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            // Determine size category
            let newSize;
            if (width < BREAKPOINTS.compact) {
                newSize = 'compact';
            } else if (width < BREAKPOINTS.medium) {
                newSize = 'medium';
            } else if (width < BREAKPOINTS.large) {
                newSize = 'large';
            } else {
                newSize = 'xlarge';
            }
            
            // Update body class for CSS targeting
            if (newSize !== currentSize) {
                document.body.classList.remove('size-compact', 'size-medium', 'size-large', 'size-xlarge');
                document.body.classList.add(`size-${newSize}`);
                currentSize = newSize;
                console.log(`Window size: ${width}x${height} (${newSize})`);
            }
            
            return { width, height, size: newSize };
        }
        
        // Debounce for performance
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
        
        // Listen for resize
        window.addEventListener('resize', debounce(detectWindowSize, 100));

        document.addEventListener('DOMContentLoaded', () => {
            // Initial size detection
            detectWindowSize();
            
            loadCouncilInfo();
            loadAvailableModels();
            loadAIProjects();
            loadChatHistory();  // Load chat history for sidebar
            loadProjectsForModal();  // Load projects count
            checkHealth();
            setupTextarea();
            setInterval(checkHealth, 30000);
            
            // Check URL params for project selection and conversation resume
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('ai_project');
            const urlSession = urlParams.get('session');
            const resumeConversationId = urlParams.get('resume_conversation');
            
            if (projectId) {
                setTimeout(() => selectAIProjectById(projectId), 500);
            }
            if (urlSession) {
                sessionId = urlSession;
            }
            
            // Resume conversation from history if specified
            if (resumeConversationId) {
                setTimeout(() => loadConversation(resumeConversationId), 300);
            }
        });

        // =============================================================================
        // Sidebar Functions
        // =============================================================================
        
        function toggleChatSidebar() {
            const sidebar = document.getElementById('chat-sidebar');
            const toggleBtn = document.getElementById('top-nav-toggle');
            const topNav = document.getElementById('top-nav');
            const chatMain = document.querySelector('.chat-main');
            
            const isCollapsed = sidebar.classList.toggle('collapsed');
            toggleBtn.classList.toggle('visible', isCollapsed);
            
            // Update main content positioning
            if (isCollapsed) {
                topNav.style.left = '0';
                chatMain.style.marginLeft = '0';
            } else {
                topNav.style.left = '280px';
                chatMain.style.marginLeft = '280px';
            }
        }
        
        function toggleNavDropdown() {
            const menu = document.getElementById('nav-dropdown-menu');
            menu.classList.toggle('open');
            
            // Close when clicking outside
            function closeDropdown(e) {
                if (!e.target.closest('.nav-dropdown')) {
                    menu.classList.remove('open');
                    document.removeEventListener('click', closeDropdown);
                }
            }
            
            setTimeout(() => {
                document.addEventListener('click', closeDropdown);
            }, 0);
        }
        
        async function loadChatHistory() {
            try {
                const response = await fetch('/api/history?page_size=50');
                if (!response.ok) return;
                
                const data = await response.json();
                chatHistory = data.items || [];
                renderChatHistory();
            } catch (e) {
                console.error('Failed to load chat history:', e);
            }
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById(`section-${sectionId}`);
            if (section) {
                section.classList.toggle('collapsed');
                // Save collapsed state to localStorage
                const collapsed = JSON.parse(localStorage.getItem('chatSectionsCollapsed') || '{}');
                collapsed[sectionId] = section.classList.contains('collapsed');
                localStorage.setItem('chatSectionsCollapsed', JSON.stringify(collapsed));
            }
        }
        
        function restoreSectionStates() {
            const collapsed = JSON.parse(localStorage.getItem('chatSectionsCollapsed') || '{}');
            Object.entries(collapsed).forEach(([sectionId, isCollapsed]) => {
                const section = document.getElementById(`section-${sectionId}`);
                if (section && isCollapsed) {
                    section.classList.add('collapsed');
                }
            });
        }
        
        function renderChatHistory() {
            const todayContainer = document.getElementById('chat-list-today');
            const weekContainer = document.getElementById('chat-list-week');
            const earlierContainer = document.getElementById('chat-list-earlier');
            
            if (!todayContainer) return;
            
            todayContainer.innerHTML = '';
            weekContainer.innerHTML = '';
            earlierContainer.innerHTML = '';
            
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(todayStart.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            let todayCount = 0, weekCount = 0, earlierCount = 0;
            
            chatHistory.forEach(chat => {
                const chatDate = new Date(chat.started_at);
                const item = createChatListItem(chat);
                
                if (chatDate >= todayStart) {
                    todayContainer.appendChild(item);
                    todayCount++;
                } else if (chatDate >= weekAgo) {
                    weekContainer.appendChild(item);
                    weekCount++;
                } else {
                    earlierContainer.appendChild(item);
                    earlierCount++;
                }
            });
            
            // Update counts
            document.getElementById('count-today').textContent = todayCount;
            document.getElementById('count-week').textContent = weekCount;
            document.getElementById('count-earlier').textContent = earlierCount;
            
            // Hide empty sections
            document.getElementById('section-today').style.display = todayCount > 0 ? 'block' : 'none';
            document.getElementById('section-week').style.display = weekCount > 0 ? 'block' : 'none';
            document.getElementById('section-earlier').style.display = earlierCount > 0 ? 'block' : 'none';
            
            // Show/hide clear all button
            const totalCount = todayCount + weekCount + earlierCount;
            document.getElementById('clear-history-btn').style.display = totalCount > 0 ? 'block' : 'none';
            
            // Restore collapsed states
            restoreSectionStates();
        }
        
        function createChatListItem(chat) {
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.dataset.conversationId = chat.conversation_id;
            if (chat.conversation_id === currentConversationId) {
                item.classList.add('active');
            }
            
            const icon = document.createElement('span');
            icon.className = 'chat-list-item-icon';
            icon.textContent = 'üí¨';
            
            const text = document.createElement('span');
            text.className = 'chat-list-item-text';
            text.textContent = chat.preview || 'New conversation';
            text.onclick = () => loadConversation(chat.conversation_id);
            
            item.appendChild(icon);
            item.appendChild(text);
            
            if (chat.project_name) {
                const projectTag = document.createElement('span');
                projectTag.className = 'chat-list-item-project';
                projectTag.textContent = chat.project_name;
                item.appendChild(projectTag);
            }
            
            // Delete button (shown on hover via CSS)
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'chat-list-item-delete';
            deleteBtn.innerHTML = '√ó';
            deleteBtn.title = 'Delete conversation';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                e.preventDefault();
                deleteConversation(chat.conversation_id);
            };
            item.appendChild(deleteBtn);
            
            // Click on the item (not delete) loads the conversation
            item.onclick = (e) => {
                if (!e.target.classList.contains('chat-list-item-delete')) {
                    loadConversation(chat.conversation_id);
                }
            };
            
            return item;
        }
        
        async function deleteConversation(conversationId) {
            if (!confirm('Delete this conversation?')) return;
            
            try {
                const response = await fetch(`/api/history/${conversationId}`, {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    // If deleting current conversation, clear the chat
                    if (conversationId === currentConversationId) {
                        startNewChat();
                    }
                    // Refresh the list
                    await loadChatHistory();
                    showToast('Conversation deleted');
                }
            } catch (e) {
                console.error('Failed to delete conversation:', e);
                showToast('Failed to delete conversation');
            }
        }
        
        async function clearAllHistory() {
            if (!confirm('Are you sure you want to delete ALL chat history? This cannot be undone.')) return;
            if (!confirm('This will permanently delete all conversations. Type OK to confirm.')) return;
            
            try {
                const response = await fetch('/api/history?confirm=true', {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    const data = await response.json();
                    startNewChat();
                    await loadChatHistory();
                    showToast(`Deleted ${data.deleted_count} conversations`);
                }
            } catch (e) {
                console.error('Failed to clear history:', e);
                showToast('Failed to clear history');
            }
        }
        
        async function loadConversation(conversationId) {
            try {
                const response = await fetch(`/api/history/${conversationId}`);
                if (!response.ok) return;
                
                const data = await response.json();
                currentConversationId = conversationId;
                
                // Restore session ID to continue this conversation
                if (data.session_id) {
                    sessionId = data.session_id;
                    localStorage.setItem('chatos_session_id', sessionId);
                }
                
                // Clear and repopulate chat
                const container = document.getElementById('chat-container');
                const welcome = document.getElementById('welcome-message');
                if (welcome) welcome.style.display = 'none';
                
                // Remove existing messages except welcome
                container.querySelectorAll('.message').forEach(m => m.remove());
                
                // Render messages
                (data.messages || []).forEach(msg => {
                    if (msg.role === 'user') {
                        appendUserMessage(msg.content);
                    } else if (msg.role === 'assistant') {
                        appendHistoryAssistantMessage(msg.content, msg.model || data.chosen_model || 'Assistant');
                    }
                });
                
                // Update active state in sidebar
                document.querySelectorAll('.chat-list-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.conversationId === conversationId) {
                        item.classList.add('active');
                    }
                });
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
                
                showToast('Conversation loaded - continue chatting!');
            } catch (e) {
                console.error('Failed to load conversation:', e);
                showToast('Failed to load conversation');
            }
        }
        
        function startNewChat() {
            currentConversationId = null;
            sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('chatos_session_id', sessionId);
            clearChat();
            
            // Update sidebar
            document.querySelectorAll('.chat-list-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Focus input
            document.getElementById('message-input')?.focus();
        }
        
        // Projects Modal Functions
        async function openProjectsModal() {
            const modal = document.getElementById('projects-modal');
            modal.classList.add('open');
            await loadProjectsForModal();
        }
        
        function closeProjectsModal() {
            const modal = document.getElementById('projects-modal');
            modal.classList.remove('open');
        }
        
        async function loadProjectsForModal() {
            try {
                const response = await fetch('/api/ai-projects');
                if (!response.ok) return;
                
                const data = await response.json();
                const projects = data.projects || [];
                
                // Update count in sidebar
                document.getElementById('projects-count').textContent = projects.length;
                
                // Render project cards
                const container = document.getElementById('projects-list');
                container.innerHTML = '';
                
                projects.forEach(project => {
                    const card = createProjectCard(project);
                    container.appendChild(card);
                });
            } catch (e) {
                console.error('Failed to load projects:', e);
            }
        }
        
        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'project-card';
            card.onclick = () => selectProject(project);
            
            card.innerHTML = `
                <div class="project-card-header">
                    <span class="project-card-icon">${project.icon || 'üìÅ'}</span>
                    <span class="project-card-name">${project.name}</span>
                </div>
                <div class="project-card-meta">
                    ${project.file_count || 0} files ‚Ä¢ ${project.chat_count || 0} chats
                </div>
            `;
            
            return card;
        }
        
        function selectProject(project) {
            selectedAIProjectId = project.id;
            selectedAIProject = project;
            
            // Show project badge
            document.getElementById('active-project-badge').style.display = 'flex';
            document.getElementById('project-badge-icon').textContent = project.icon || 'üìÅ';
            document.getElementById('project-badge-name').textContent = project.name;
            
            closeProjectsModal();
            
            // Start new chat with project context
            startNewChat();
        }
        
        function clearAIProject() {
            selectedAIProjectId = null;
            selectedAIProject = null;
            document.getElementById('active-project-badge').style.display = 'none';
        }
        
        let editingProjectId = null;
        let pendingProjectFiles = [];
        
        function openProjectEditor(projectId = null) {
            const modal = document.getElementById('project-editor-modal');
            const titleEl = document.getElementById('editor-modal-title');
            
            editingProjectId = projectId;
            pendingProjectFiles = [];
            
            if (projectId) {
                titleEl.textContent = '‚úèÔ∏è Edit Project';
                loadProjectForEdit(projectId);
            } else {
                titleEl.textContent = '‚ûï Create Project';
                document.getElementById('project-form').reset();
                document.getElementById('edit-project-id').value = '';
                document.getElementById('project-files-list').innerHTML = '';
            }
            
            closeProjectsModal();
            modal.classList.add('open');
        }
        
        function closeProjectEditor() {
            document.getElementById('project-editor-modal').classList.remove('open');
            editingProjectId = null;
            pendingProjectFiles = [];
        }
        
        async function loadProjectForEdit(projectId) {
            try {
                const response = await fetch(`/api/ai-projects/${projectId}`);
                if (!response.ok) return;
                
                const project = await response.json();
                
                document.getElementById('edit-project-id').value = project.id;
                document.getElementById('project-name-input').value = project.name || '';
                document.getElementById('project-icon-input').value = project.icon || 'üìÅ';
                document.getElementById('project-color-input').value = project.color || '#2B26FE';
                document.getElementById('project-instructions-input').value = project.system_prompt || '';
                
                // Load existing files
                renderProjectFiles(project.files || []);
            } catch (e) {
                console.error('Failed to load project:', e);
            }
        }
        
        function renderProjectFiles(files) {
            const container = document.getElementById('project-files-list');
            if (!files || files.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = files.map(file => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 6px;">
                    <span>üìÑ</span>
                    <span style="flex: 1;">${typeof file === 'string' ? file : file.name}</span>
                    <button type="button" onclick="removeProjectFile('${typeof file === 'string' ? file : file.name}')" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">√ó</button>
                </div>
            `).join('');
        }
        
        function handleProjectFileUpload(event) {
            const files = Array.from(event.target.files);
            pendingProjectFiles.push(...files);
            
            // Show pending files
            const existingFiles = document.getElementById('project-files-list').querySelectorAll('div').length;
            const newFilesHtml = files.map(file => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 6px;">
                    <span>üìÑ</span>
                    <span style="flex: 1;">${file.name}</span>
                    <span style="font-size: 11px; color: var(--accent-primary);">NEW</span>
                </div>
            `).join('');
            
            document.getElementById('project-files-list').innerHTML += newFilesHtml;
        }
        
        function removeProjectFile(filename) {
            pendingProjectFiles = pendingProjectFiles.filter(f => f.name !== filename);
            // Re-render (simplified - would need project files list for full implementation)
            const container = document.getElementById('project-files-list');
            const items = container.querySelectorAll('div');
            items.forEach(item => {
                if (item.textContent.includes(filename)) {
                    item.remove();
                }
            });
        }
        
        async function saveProject(event) {
            event.preventDefault();
            
            const projectId = document.getElementById('edit-project-id').value;
            const name = document.getElementById('project-name-input').value;
            const icon = document.getElementById('project-icon-input').value;
            const color = document.getElementById('project-color-input').value;
            const systemPrompt = document.getElementById('project-instructions-input').value;
            
            const payload = {
                name,
                icon,
                color,
                system_prompt: systemPrompt,
            };
            
            try {
                let response;
                if (projectId) {
                    // Update existing
                    response = await fetch(`/api/ai-projects/${projectId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                } else {
                    // Create new
                    response = await fetch('/api/ai-projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                }
                
                if (!response.ok) {
                    throw new Error('Failed to save project');
                }
                
                const savedProject = await response.json();
                
                // Upload pending files
                for (const file of pendingProjectFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    await fetch(`/api/ai-projects/${savedProject.id}/files`, {
                        method: 'POST',
                        body: formData,
                    });
                }
                
                closeProjectEditor();
                loadProjectsForModal();
                showToast(projectId ? 'Project updated!' : 'Project created!');
                
            } catch (e) {
                console.error('Failed to save project:', e);
                showToast('Failed to save project');
            }
            
            return false;
        }
        
        // =============================================================================
        // API Calls
        // =============================================================================
        
        async function loadCouncilInfo() {
            try {
                const response = await fetch('/api/council');
                councilInfo = await response.json();
                updateStrategyDisplay(councilInfo.strategy);
            } catch (error) {
                console.error('Failed to load council info:', error);
            }
        }

        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/models?enabled_only=true');
                availableModels = await response.json();
                renderModelSelector(availableModels);
                renderModelList(availableModels);
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        async function loadAIProjects() {
            try {
                const response = await fetch('/api/ai-projects');
                const data = await response.json();
                aiProjects = data.projects;
                renderAIProjectSelector();
            } catch (error) {
                console.error('Failed to load AI projects:', error);
            }
        }

        async function resumeConversation(conversationId) {
            try {
                const response = await fetch(`/api/history/${conversationId}`);
                if (!response.ok) {
                    showToast('Could not load conversation');
                    return;
                }
                
                const conversation = await response.json();
                
                // Update session ID to continue this conversation
                if (conversation.session_id) {
                    sessionId = conversation.session_id;
                }
                
                // Hide welcome message
                hideWelcomeMessage();
                
                // Render all messages from the conversation
                const container = document.getElementById('chat-container');
                container.innerHTML = '';  // Clear existing messages
                
                for (const msg of conversation.messages) {
                    if (msg.role === 'user') {
                        appendUserMessage(msg.content);
                    } else if (msg.role === 'assistant') {
                        // Create a simplified response object for the assistant message
                        appendResumedAssistantMessage({
                            answer: msg.content,
                            chosen_model: msg.model || conversation.chosen_model || 'Unknown',
                            mode: conversation.mode || 'normal',
                            timestamp: msg.timestamp,
                        });
                    }
                }
                
                // Show a toast to indicate conversation was loaded
                showToast('üìú Conversation resumed - continue chatting!');
                
                // Scroll to bottom
                scrollToBottom();
                
            } catch (error) {
                console.error('Failed to resume conversation:', error);
                showToast('Failed to resume conversation');
            }
        }
        
        function appendResumedAssistantMessage(data) {
            const container = document.getElementById('chat-container');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant-message';
            
            const formattedAnswer = formatResponse(data.answer);
            const modeIcon = getModeIcon(data.mode);
            
            messageEl.innerHTML = `
                <div class="message-avatar assistant-avatar">${modeIcon}</div>
                <div class="message-content">
                    <div class="message-meta">
                        <span class="response-mode-badge council">üìú History</span>
                        <span class="chosen-model">${escapeHtml(data.chosen_model)}</span>
                        ${data.timestamp ? `<span class="meta-separator">‚Ä¢</span><span class="memory-summary">${formatTimestamp(data.timestamp)}</span>` : ''}
                    </div>
                    <div class="message-text">${formattedAnswer}</div>
                </div>
            `;
            container.appendChild(messageEl);
        }
        
        function appendHistoryAssistantMessage(content, modelName) {
            const container = document.getElementById('chat-container');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant-message';
            
            const formattedContent = formatResponse(content);
            
            messageEl.innerHTML = `
                <div class="message-avatar assistant-avatar">üí¨</div>
                <div class="message-content">
                    <div class="message-meta">
                        <span class="response-mode-badge council">üìú</span>
                        <span class="chosen-model">${escapeHtml(modelName)}</span>
                    </div>
                    <div class="message-text">${formattedContent}</div>
                </div>
            `;
            container.appendChild(messageEl);
        }
        
        function formatTimestamp(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString([], { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        async function selectAIProjectById(projectId) {
            try {
                const response = await fetch(`/api/ai-projects/${projectId}`);
                if (!response.ok) return;
                
                selectedAIProject = await response.json();
                selectedAIProjectId = projectId;
                
                // Update selector
                const selector = document.getElementById('ai-project-selector');
                if (selector) selector.value = projectId;
                
                // Apply project settings
                applyAIProjectSettings();
                updateAIProjectBadge();
            } catch (error) {
                console.error('Failed to load AI project:', error);
            }
        }

        function renderAIProjectSelector() {
            const selector = document.getElementById('ai-project-selector');
            if (!selector) return;
            
            selector.innerHTML = '<option value="">No Project</option>' +
                aiProjects.map(p => `<option value="${p.id}">${p.icon} ${p.name}</option>`).join('');
        }

        function onAIProjectSelect(selectElement) {
            const projectId = selectElement.value;
            if (projectId) {
                selectAIProjectById(projectId);
            } else {
                clearAIProject();
            }
        }

        function applyAIProjectSettings() {
            if (!selectedAIProject) return;
            
            // Optionally apply project's default model
            if (selectedAIProject.default_model_id) {
                const modelSelector = document.getElementById('model-selector');
                if (modelSelector) {
                    modelSelector.value = selectedAIProject.default_model_id;
                    selectedModelId = selectedAIProject.default_model_id;
                    updateModelSelectionUI();
                }
            }
        }

        function updateAIProjectBadge() {
            const badge = document.getElementById('active-project-badge');
            if (!badge) return;
            
            if (selectedAIProject) {
                badge.style.display = 'flex';
                document.getElementById('project-badge-icon').textContent = selectedAIProject.icon;
                document.getElementById('project-badge-icon').style.background = `${selectedAIProject.color}20`;
                document.getElementById('project-badge-icon').style.color = selectedAIProject.color;
                document.getElementById('project-badge-name').textContent = selectedAIProject.name;
            } else {
                badge.style.display = 'none';
            }
        }

        function clearAIProject() {
            selectedAIProjectId = null;
            selectedAIProject = null;
            
            const selector = document.getElementById('ai-project-selector');
            if (selector) selector.value = '';
            
            updateAIProjectBadge();
            
            // Clear URL params
            const url = new URL(window.location);
            url.searchParams.delete('ai_project');
            url.searchParams.delete('session');
            window.history.replaceState({}, '', url);
        }

        async function checkHealth() {
            const indicator = document.getElementById('health-indicator');
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                if (data.status === 'healthy') {
                    indicator.classList.add('healthy');
                    indicator.innerHTML = `
                        <span class="health-dot"></span>
                        <span>${data.models_loaded} models ‚Ä¢ ${data.rag_documents} docs</span>
                    `;
                }
            } catch (error) {
                indicator.classList.remove('healthy');
                indicator.innerHTML = `
                    <span class="health-dot"></span>
                    <span>Connection error</span>
                `;
            }
        }

        async function sendMessage(message, useRag) {
            const attachmentIds = attachments.map(a => a.id);
            
            // Use AbortController for timeout (5 minutes for complex LLM queries)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minutes
            
            try {
                const requestBody = {
                    message: message,
                    mode: 'normal',
                    use_rag: useRag,
                    session_id: sessionId,
                    attachment_ids: attachmentIds.length > 0 ? attachmentIds : null,
                };
                
                // Add model_id if a specific model is selected
                if (selectedModelId) {
                    requestBody.model_id = selectedModelId;
                }
                
                // Add ai_project_id if a project is selected
                if (selectedAIProjectId) {
                    requestBody.ai_project_id = selectedAIProjectId;
                }
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal,
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Clear attachments after sending
                attachments = [];
                renderAttachmentPreview();

                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. The model is taking too long to respond.');
                }
                throw error;
            }
        }

        // =============================================================================
        // File Attachments
        // =============================================================================
        
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (const file of files) {
                await uploadFile(file);
            }
            
            event.target.value = '';  // Reset input
        }

        async function uploadFile(file) {
            // Check size
            if (file.size > 10 * 1024 * 1024) {
                alert('File too large. Max 10MB.');
                return;
            }
            
            // Read as base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                
                try {
                    const response = await fetch('/api/attachments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: file.name,
                            content_base64: base64,
                            session_id: sessionId,
                        }),
                    });
                    
                    if (response.ok) {
                        const attachment = await response.json();
                        attachments.push(attachment);
                        renderAttachmentPreview();
                    } else {
                        const err = await response.json();
                        alert('Upload failed: ' + err.detail);
                    }
                } catch (e) {
                    alert('Upload failed: ' + e.message);
                }
            };
            reader.readAsDataURL(file);
        }

        function renderAttachmentPreview() {
            const container = document.getElementById('attachment-preview');
            const list = document.getElementById('attachment-list');
            
            if (attachments.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = attachments.map((a, i) => `
                <div class="attachment-item">
                    <span class="attachment-icon">${getFileIcon(a.original_filename)}</span>
                    <span class="attachment-name">${a.original_filename}</span>
                    <span class="attachment-size">${formatFileSize(a.size)}</span>
                    <button class="attachment-remove" onclick="removeAttachment(${i})">√ó</button>
                </div>
            `).join('');
        }

        function removeAttachment(index) {
            attachments.splice(index, 1);
            renderAttachmentPreview();
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'py': 'üêç', 'js': 'üìú', 'ts': 'üìò', 'json': 'üìã',
                'html': 'üåê', 'css': 'üé®', 'md': 'üìù', 'txt': 'üìÑ',
                'sh': '‚öôÔ∏è', 'sql': 'üóÉÔ∏è',
            };
            return icons[ext] || 'üìé';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // =============================================================================
        // UI Rendering
        // =============================================================================
        
        function renderModelList(models) {
            const container = document.getElementById('model-list');
            if (!container) return; // Element may not exist in current view
            // Filter to show only real models (not dummy) in the sidebar
            const realModels = models.filter(m => m.provider !== 'dummy');
            container.innerHTML = realModels.map(model => `
                <div class="model-item ${model.is_council_member ? 'council-member' : ''}" 
                     data-model="${model.name}" 
                     data-model-id="${model.id}"
                     onclick="selectModelFromSidebar('${model.id}')">
                    <span class="model-icon">${getProviderIcon(model.provider)}</span>
                    <div class="model-info">
                        <span class="model-name">${model.name}</span>
                        <span class="model-behavior">${model.model_id}</span>
                    </div>
                    ${model.is_council_member ? '<span class="council-badge">üë•</span>' : ''}
                </div>
            `).join('');
        }

        function renderModelSelector(models) {
            const selector = document.getElementById('top-model-selector');
            if (!selector) return;
            
            // Filter to real models only
            const realModels = models.filter(m => m.provider !== 'dummy');
            
            let options = '<option value="">üèõÔ∏è Council</option>';
            realModels.forEach(model => {
                const icon = getProviderIcon(model.provider);
                options += `<option value="${model.id}">${icon} ${model.name}</option>`;
            });
            
            selector.innerHTML = options;
        }

        function selectModelFromSidebar(modelId) {
            selectedModelId = modelId;
            const selector = document.getElementById('top-model-selector');
            if (selector) {
                selector.value = modelId;
            }
            updateModelSelectionUI();
        }

        function onModelSelect(selectElement) {
            selectedModelId = selectElement.value || null;
            updateModelSelectionUI();
        }

        function updateModelSelectionUI() {
            // Update sidebar highlighting
            document.querySelectorAll('.model-item').forEach(el => {
                el.classList.remove('selected');
                if (selectedModelId && el.dataset.modelId === selectedModelId) {
                    el.classList.add('selected');
                }
            });
            
            // Update the indicator text
            const indicator = document.getElementById('model-mode-indicator');
            if (indicator) {
                if (selectedModelId) {
                    const model = availableModels.find(m => m.id === selectedModelId);
                    indicator.textContent = model ? `Using: ${model.name}` : 'Single Model';
                    indicator.classList.add('single-mode');
                } else {
                    indicator.textContent = 'Council Mode';
                    indicator.classList.remove('single-mode');
                }
            }
        }

        function getProviderIcon(provider) {
            const icons = {
                'ollama': 'ü¶ô',
                'openai': 'ü§ñ',
                'anthropic': 'üß†',
                'google': 'üîÆ',
                'lm_studio': 'üíª',
                'groq': '‚ö°',
                'dummy': 'üé≠',
            };
            return icons[provider] || 'ü§ñ';
        }

        function getModelIcon(behavior) {
            const icons = {
                'thoughtful': 'üß†',
                'concise': '‚ö°',
                'creative': 'üé®',
                'analytical': 'üìä',
            };
            return icons[behavior] || 'ü§ñ';
        }

        function getModeIcon(mode) {
            const icons = {
                'research': 'üî¨',
                'deepthinking': 'üß†',
                'swarm': 'üêù',
                'code': '‚å®Ô∏è',
                'reason': 'üí°',
                'normal': 'üí¨',
            };
            return icons[mode] || 'üí¨';
        }

        function updateStrategyDisplay(strategy) {
            const display = document.getElementById('strategy-display');
            if (!display) return; // Element may not exist in current view
            const strategies = {
                'longest': { icon: 'üìè', text: 'Longest wins' },
                'shortest': { icon: '‚úÇÔ∏è', text: 'Shortest wins' },
                'random': { icon: 'üé≤', text: 'Random selection' },
                'first': { icon: '1Ô∏è‚É£', text: 'First response' },
            };
            const info = strategies[strategy] || strategies['longest'];
            display.innerHTML = `
                <span class="strategy-icon">${info.icon}</span>
                <span>${info.text}</span>
            `;
        }

        function hideWelcomeMessage() {
            const welcome = document.getElementById('welcome-message');
            if (welcome) welcome.style.display = 'none';
        }

        function appendUserMessage(text) {
            hideWelcomeMessage();
            const container = document.getElementById('chat-container');
            const isCommand = text.startsWith('/');
            const messageEl = document.createElement('div');
            messageEl.className = 'message user-message';
            messageEl.innerHTML = `
                <div class="message-content">
                    <div class="message-text ${isCommand ? 'command-text' : ''}">${escapeHtml(text)}</div>
                </div>
                <div class="message-avatar user-avatar">You</div>
            `;
            container.appendChild(messageEl);
            scrollToBottom();
        }

        function appendAssistantMessage(data) {
            const container = document.getElementById('chat-container');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant-message';
            
            // Safely extract data with defaults
            const answer = data?.answer || 'No response received';
            const chosenModel = data?.chosen_model || 'Unknown';
            const responses = data?.responses || [];
            const mode = data?.mode || 'normal';
            const memorySummary = data?.memory_summary || '';
            const conversationId = data?.conversation_id || '';
            
            // Store conversation ID for feedback
            messageEl.dataset.conversationId = conversationId;
            
            // Determine if this was a single model or council response
            const isSingleModel = responses.length <= 1;
            const responseModeBadge = isSingleModel 
                ? '<span class="response-mode-badge single">üéØ Single</span>'
                : '<span class="response-mode-badge council">üèõÔ∏è Council</span>';
            
            const formattedAnswer = formatResponse(answer);
            const modeIcon = isSingleModel ? 'üéØ' : getModeIcon(mode);
            const modeBadge = data?.command ? `<span class="mode-badge">${getModeIcon(mode)} /${data.command}</span>` : '';
            
            const responsesHtml = responses.map(r => `
                <div class="model-response ${r.model === chosenModel ? 'chosen' : ''}">
                    <div class="model-response-header">
                        <span class="model-response-name">${escapeHtml(r.model || 'Unknown')}</span>
                        ${r.model === chosenModel ? '<span class="chosen-badge">‚úì Chosen</span>' : ''}
                    </div>
                    <div class="model-response-text">${escapeHtml(r.text || '')}</div>
                </div>
            `).join('');
            
            // Feedback buttons HTML
            const feedbackHtml = conversationId ? `
                <div class="feedback-buttons" data-conversation-id="${escapeHtml(conversationId)}">
                    <button class="feedback-btn thumbs-up" onclick="sendFeedback('${escapeHtml(conversationId)}', true)" title="Good response">
                        üëç
                    </button>
                    <button class="feedback-btn thumbs-down" onclick="sendFeedback('${escapeHtml(conversationId)}', false)" title="Poor response">
                        üëé
                    </button>
                </div>
            ` : '';

            messageEl.innerHTML = `
                <div class="message-avatar assistant-avatar">${modeIcon}</div>
                <div class="message-content">
                    <div class="message-meta">
                        ${responseModeBadge}
                        <span class="chosen-model">${escapeHtml(chosenModel)}</span>
                        ${modeBadge}
                        <span class="meta-separator">‚Ä¢</span>
                        <span class="memory-summary">${escapeHtml(memorySummary)}</span>
                    </div>
                    <div class="message-text">${formattedAnswer}</div>
                    ${responses.length > 1 ? `
                    <details class="responses-details">
                        <summary class="responses-summary">
                            <span>Show all ${responses.length} council responses</span>
                            <span class="expand-icon">‚ñº</span>
                        </summary>
                        <div class="responses-list">${responsesHtml}</div>
                    </details>
                    ` : ''}
                    <div class="message-actions">
                        ${feedbackHtml}
                    </div>
                </div>
            `;
            container.appendChild(messageEl);
            highlightChosenModel(chosenModel);
            scrollToBottom();
        }
        
        // Feedback handling
        async function sendFeedback(conversationId, thumbsUp) {
            try {
                const response = await fetch(`/api/memory/feedback/${conversationId}?thumbs_up=${thumbsUp}`, {
                    method: 'POST',
                });
                
                if (response.ok) {
                    // Update button state
                    const container = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                    if (container) {
                        const thumbsUpBtn = container.querySelector('.thumbs-up');
                        const thumbsDownBtn = container.querySelector('.thumbs-down');
                        
                        if (thumbsUp) {
                            thumbsUpBtn.classList.add('active');
                            thumbsDownBtn.classList.remove('active');
                        } else {
                            thumbsDownBtn.classList.add('active');
                            thumbsUpBtn.classList.remove('active');
                        }
                        
                        // Show feedback toast
                        showToast(thumbsUp ? 'Thanks for the feedback! üëç' : 'Feedback recorded. We\'ll improve! üîÑ');
                    }
                }
            } catch (error) {
                console.error('Feedback error:', error);
            }
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function appendLoadingMessage(mode = 'normal') {
            const container = document.getElementById('chat-container');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message assistant-message loading-message';
            loadingEl.id = 'loading-message';
            
            // Determine loading text based on mode AND model selection
            let modeText;
            let avatarIcon;
            
            if (selectedModelId) {
                // Single model mode
                const model = availableModels.find(m => m.id === selectedModelId);
                const modelName = model ? model.name : 'Model';
                modeText = {
                    'research': 'Researching...',
                    'deepthinking': 'Thinking deeply...',
                    'swarm': 'Swarm collaborating...',
                    'code': `${modelName} is coding...`,
                    'reason': 'PersRM reasoning...',
                    'normal': `${modelName} is thinking...`,
                }[mode] || `${modelName} is processing...`;
                avatarIcon = 'üéØ';
            } else {
                // Council mode
                modeText = {
                    'research': 'Researching...',
                    'deepthinking': 'Thinking deeply...',
                    'swarm': 'Swarm collaborating...',
                    'code': 'Council is generating code...',
                    'reason': 'PersRM reasoning...',
                    'normal': 'Council is deliberating...',
                }[mode] || 'Processing...';
                avatarIcon = getModeIcon(mode);
            }
            
            loadingEl.innerHTML = `
                <div class="message-avatar assistant-avatar">${avatarIcon}</div>
                <div class="message-content">
                    <div class="loading-indicator">
                        <span class="loading-dot"></span>
                        <span class="loading-dot"></span>
                        <span class="loading-dot"></span>
                        <span class="loading-text">${modeText}</span>
                    </div>
                </div>
            `;
            container.appendChild(loadingEl);
            scrollToBottom();
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loading-message');
            if (loading) loading.remove();
        }

        function appendErrorMessage(error) {
            const container = document.getElementById('chat-container');
            const messageEl = document.createElement('div');
            messageEl.className = 'message error-message';
            messageEl.innerHTML = `
                <div class="message-avatar error-avatar">‚ö†Ô∏è</div>
                <div class="message-content">
                    <div class="message-text">Error: ${escapeHtml(error)}</div>
                </div>
            `;
            container.appendChild(messageEl);
            scrollToBottom();
        }

        function highlightChosenModel(modelName) {
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('chosen'));
            const chosenEl = document.querySelector(`.model-item[data-model="${modelName}"]`);
            if (chosenEl) chosenEl.classList.add('chosen');
        }

        function highlightCommand(command) {
            document.querySelectorAll('.command-item').forEach(el => el.classList.remove('active'));
            if (command) {
                const cmdEl = document.querySelector(`.command-item[data-command="${command}"]`);
                if (cmdEl) cmdEl.classList.add('active');
            }
        }

        // =============================================================================
        // Event Handlers
        // =============================================================================
        
        async function handleSubmit(event) {
            // Prevent form submission / page refresh
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (isLoading) return false;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return false;
            
            const useRag = document.getElementById('use-rag')?.checked ?? true;
            
            // Detect mode from message
            let mode = 'normal';
            if (message.startsWith('/research')) mode = 'research';
            else if (message.startsWith('/deepthinking')) mode = 'deepthinking';
            else if (message.startsWith('/swarm')) mode = 'swarm';
            else if (message.startsWith('/code')) mode = 'code';
            else if (message.startsWith('/reason')) mode = 'reason';
            
            input.value = '';
            resetTextareaHeight();
            hideInputHints();
            appendUserMessage(message);
            highlightCommand(mode !== 'normal' ? mode : null);
            
            isLoading = true;
            updateSendButton(true);
            appendLoadingMessage(mode);
            
            try {
                const data = await sendMessage(message, useRag);
                removeLoadingMessage();
                appendAssistantMessage(data);
                
                // Update current conversation ID and refresh sidebar
                if (data.conversation_id) {
                    currentConversationId = data.conversation_id;
                }
                // Refresh chat history in sidebar to show new/updated conversation
                setTimeout(() => loadChatHistory(), 500);
            } catch (error) {
                console.error('Chat error:', error);
                removeLoadingMessage();
                appendErrorMessage(error.message || 'An error occurred');
            } finally {
                isLoading = false;
                updateSendButton(false);
                highlightCommand(null);
            }
            
            return false; // Prevent form submission
        }

        function insertCommand(command) {
            const input = document.getElementById('message-input');
            input.value = `/${command} `;
            input.focus();
            showInputHints(command);
        }

        function clearChat() {
            const container = document.getElementById('chat-container');
            container.innerHTML = `
                <div class="welcome-message" id="welcome-message">
                    <div class="welcome-icon">ü§ñ</div>
                    <h2>Welcome to ChatOS</h2>
                    <p>Start a conversation with your local AI council.</p>
                </div>
            `;
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('chosen'));
        }

        // =============================================================================
        // Utilities
        // =============================================================================
        
        function setupTextarea() {
            const textarea = document.getElementById('message-input');
            
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
                
                // Check for command hints
                const value = textarea.value;
                if (value.startsWith('/')) {
                    const cmd = value.slice(1).split(' ')[0];
                    showInputHints(cmd);
                } else {
                    hideInputHints();
                }
            });
            
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleSubmit(e);
                }
                if (e.key === 'Escape') {
                    textarea.value = '';
                    resetTextareaHeight();
                    hideInputHints();
                }
            });
        }

        function showInputHints(command) {
            const hints = document.getElementById('input-hints');
            const hintText = {
                'research': 'üî¨ Research: Add your query to search the web for context',
                'deepthinking': 'üß† Deep Thinking: Add a problem to analyze with extended reasoning',
                'swarm': 'üêù Swarm: Describe a coding task for multi-agent collaboration',
                'code': '‚å®Ô∏è Code: Add your coding request',
            }[command];
            
            if (hintText) {
                hints.textContent = hintText;
                hints.style.display = 'block';
            } else {
                hints.style.display = 'none';
            }
        }

        function hideInputHints() {
            document.getElementById('input-hints').style.display = 'none';
        }

        function resetTextareaHeight() {
            const textarea = document.getElementById('message-input');
            textarea.style.height = 'auto';
        }

        function updateSendButton(loading) {
            const button = document.getElementById('send-button');
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<span class="send-icon spinning">‚Üª</span>';
            } else {
                button.disabled = false;
                button.innerHTML = '<span class="send-icon">‚û§</span>';
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatResponse(text) {
            let formatted = escapeHtml(text);
            
            // Convert markdown headers
            formatted = formatted.replace(/^### (.+)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^# (.+)$/gm, '<h2>$1</h2>');
            
            // Convert bold
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert code blocks
            formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre class="code-block"><code class="language-${lang || 'plaintext'}">${code.trim()}</code></pre>`;
            });
            
            // Convert inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            // Convert bullet points
            formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // Convert checkboxes
            formatted = formatted.replace(/\[x\]/g, '‚úÖ');
            formatted = formatted.replace(/\[ \]/g, '‚¨ú');
            
            // Convert line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
    </script>
</body>
</html>
