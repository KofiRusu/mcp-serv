<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatOS</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span class="logo-icon">‚ö°</span>
                    <span class="logo-text">ChatOS</span>
                </div>
                <span class="version">v0.1</span>
            </div>

            <!-- Command Palette -->
            <div class="sidebar-section">
                <h3 class="section-title">Commands</h3>
                <div class="command-list" id="command-list">
                    <div class="command-item" data-command="research" onclick="insertCommand('research')">
                        <span class="command-icon">üî¨</span>
                        <div class="command-info">
                            <span class="command-name">/research</span>
                            <span class="command-desc">Deep web research</span>
                        </div>
                    </div>
                    <div class="command-item" data-command="deepthinking" onclick="insertCommand('deepthinking')">
                        <span class="command-icon">üß†</span>
                        <div class="command-info">
                            <span class="command-name">/deepthinking</span>
                            <span class="command-desc">Chain-of-thought</span>
                        </div>
                    </div>
                    <div class="command-item" data-command="swarm" onclick="insertCommand('swarm')">
                        <span class="command-icon">üêù</span>
                        <div class="command-info">
                            <span class="command-name">/swarm</span>
                            <span class="command-desc">Multi-agent coding</span>
                        </div>
                    </div>
                    <div class="command-item" data-command="code" onclick="insertCommand('code')">
                        <span class="command-icon">‚å®Ô∏è</span>
                        <div class="command-info">
                            <span class="command-name">/code</span>
                            <span class="command-desc">Code generation</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="section-title">Council Models</h3>
                <div id="model-list" class="model-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="section-title">Settings</h3>
                
                <div class="setting-item">
                    <label class="toggle-label">
                        <input type="checkbox" id="use-rag" checked>
                        <span class="toggle-switch"></span>
                        <span>Use RAG</span>
                    </label>
                    <small class="setting-hint">Include local document context</small>
                </div>
            </div>

            <div class="sidebar-section">
                <h3 class="section-title">Strategy</h3>
                <div class="strategy-badge" id="strategy-display">
                    <span class="strategy-icon">üéØ</span>
                    <span>Longest wins</span>
                </div>
            </div>

            <div class="sidebar-footer">
                <a href="/sandbox" class="btn btn-primary btn-small sidebar-btn">
                    üíª Coding Sandbox
                </a>
                <button class="btn btn-secondary btn-small" onclick="clearChat()">
                    üóëÔ∏è Clear Chat
                </button>
                <div class="health-indicator" id="health-indicator">
                    <span class="health-dot"></span>
                    <span>Connecting...</span>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <div class="chat-header">
                <h1>Council Chat</h1>
                <p class="chat-subtitle">Multiple models. One answer. Use /commands for special modes.</p>
            </div>

            <div class="chat-container" id="chat-container">
                <div class="welcome-message" id="welcome-message">
                    <div class="welcome-icon">ü§ñ</div>
                    <h2>Welcome to ChatOS</h2>
                    <p>Start a conversation with your local AI council, or use special commands for advanced features.</p>
                    <div class="welcome-tips">
                        <div class="tip">
                            <span class="tip-icon">üî¨</span>
                            <span><strong>/research</strong> - Deep research with web context</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üß†</span>
                            <span><strong>/deepthinking</strong> - Extended chain-of-thought</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üêù</span>
                            <span><strong>/swarm</strong> - Multi-agent coding collaboration</span>
                        </div>
                        <div class="tip">
                            <span class="tip-icon">üíª</span>
                            <span><strong>Sandbox</strong> - Full coding environment</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <form id="chat-form" onsubmit="handleSubmit(event)">
                    <div class="input-wrapper">
                        <textarea 
                            id="message-input" 
                            placeholder="Type your message or /command... (Shift+Enter for new line)"
                            rows="1"
                            autofocus
                        ></textarea>
                        <button type="submit" class="send-button" id="send-button">
                            <span class="send-icon">‚û§</span>
                        </button>
                    </div>
                    <div class="input-hints" id="input-hints"></div>
                </form>
            </div>
        </main>
    </div>

    <script>
        // =============================================================================
        // State
        // =============================================================================
        
        let isLoading = false;
        let councilInfo = null;
        let commandSuggestions = [];

        // =============================================================================
        // Initialization
        // =============================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadCouncilInfo();
            checkHealth();
            setupTextarea();
            setInterval(checkHealth, 30000);
        });

        // =============================================================================
        // API Calls
        // =============================================================================
        
        async function loadCouncilInfo() {
            try {
                const response = await fetch('/api/council');
                councilInfo = await response.json();
                renderModelList(councilInfo.models);
                updateStrategyDisplay(councilInfo.strategy);
            } catch (error) {
                console.error('Failed to load council info:', error);
            }
        }

        async function checkHealth() {
            const indicator = document.getElementById('health-indicator');
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                if (data.status === 'healthy') {
                    indicator.innerHTML = `
                        <span class="health-dot healthy"></span>
                        <span>${data.models_loaded} models ‚Ä¢ ${data.rag_documents} docs</span>
                    `;
                }
            } catch (error) {
                indicator.innerHTML = `
                    <span class="health-dot error"></span>
                    <span>Connection error</span>
                `;
            }
        }

        async function sendMessage(message, useRag) {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    mode: 'normal',
                    use_rag: useRag,
                }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        // =============================================================================
        // UI Rendering
        // =============================================================================
        
        function renderModelList(models) {
            const container = document.getElementById('model-list');
            container.innerHTML = models.map(model => `
                <div class="model-item" data-model="${model.name}">
                    <span class="model-icon">${getModelIcon(model.behavior)}</span>
                    <div class="model-info">
                        <span class="model-name">${model.name}</span>
                        <span class="model-behavior">${model.behavior}</span>
                    </div>
                </div>
            `).join('');
        }

        function getModelIcon(behavior) {
            const icons = {
                'thoughtful': 'üß†',
                'concise': '‚ö°',
                'creative': 'üé®',
                'analytical': 'üìä',
            };
            return icons[behavior] || 'ü§ñ';
        }

        function getModeIcon(mode) {
            const icons = {
                'research': 'üî¨',
                'deepthinking': 'üß†',
                'swarm': 'üêù',
                'code': '‚å®Ô∏è',
                'normal': 'üí¨',
            };
            return icons[mode] || 'üí¨';
        }

        function updateStrategyDisplay(strategy) {
            const display = document.getElementById('strategy-display');
            const strategies = {
                'longest': { icon: 'üìè', text: 'Longest wins' },
                'shortest': { icon: '‚úÇÔ∏è', text: 'Shortest wins' },
                'random': { icon: 'üé≤', text: 'Random selection' },
                'first': { icon: '1Ô∏è‚É£', text: 'First response' },
            };
            const info = strategies[strategy] || strategies['longest'];
            display.innerHTML = `
                <span class="strategy-icon">${info.icon}</span>
                <span>${info.text}</span>
            `;
        }

        function hideWelcomeMessage() {
            const welcome = document.getElementById('welcome-message');
            if (welcome) welcome.style.display = 'none';
        }

        function appendUserMessage(text) {
            hideWelcomeMessage();
            const container = document.getElementById('chat-container');
            const isCommand = text.startsWith('/');
            const messageEl = document.createElement('div');
            messageEl.className = 'message user-message';
            messageEl.innerHTML = `
                <div class="message-content">
                    <div class="message-text ${isCommand ? 'command-text' : ''}">${escapeHtml(text)}</div>
                </div>
                <div class="message-avatar user-avatar">You</div>
            `;
            container.appendChild(messageEl);
            scrollToBottom();
        }

        function appendAssistantMessage(data) {
            const container = document.getElementById('chat-container');
            const messageEl = document.createElement('div');
            messageEl.className = 'message assistant-message';
            
            const formattedAnswer = formatResponse(data.answer);
            const modeIcon = getModeIcon(data.mode || 'normal');
            const modeBadge = data.command ? `<span class="mode-badge">${modeIcon} /${data.command}</span>` : '';
            
            const responsesHtml = data.responses.map(r => `
                <div class="model-response ${r.model === data.chosen_model ? 'chosen' : ''}">
                    <div class="model-response-header">
                        <span class="model-response-name">${r.model}</span>
                        ${r.model === data.chosen_model ? '<span class="chosen-badge">‚úì Chosen</span>' : ''}
                    </div>
                    <div class="model-response-text">${escapeHtml(r.text)}</div>
                </div>
            `).join('');

            messageEl.innerHTML = `
                <div class="message-avatar assistant-avatar">${modeIcon}</div>
                <div class="message-content">
                    <div class="message-meta">
                        <span class="chosen-model">${data.chosen_model}</span>
                        ${modeBadge}
                        <span class="meta-separator">‚Ä¢</span>
                        <span class="memory-summary">${data.memory_summary || ''}</span>
                    </div>
                    <div class="message-text">${formattedAnswer}</div>
                    <details class="responses-details">
                        <summary class="responses-summary">
                            <span>Show all ${data.responses.length} responses</span>
                            <span class="expand-icon">‚ñº</span>
                        </summary>
                        <div class="responses-list">${responsesHtml}</div>
                    </details>
                </div>
            `;
            container.appendChild(messageEl);
            highlightChosenModel(data.chosen_model);
            scrollToBottom();
        }

        function appendLoadingMessage(mode = 'normal') {
            const container = document.getElementById('chat-container');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message assistant-message loading-message';
            loadingEl.id = 'loading-message';
            
            const modeText = {
                'research': 'Researching...',
                'deepthinking': 'Thinking deeply...',
                'swarm': 'Swarm collaborating...',
                'code': 'Generating code...',
                'normal': 'Council is deliberating...',
            }[mode] || 'Processing...';
            
            loadingEl.innerHTML = `
                <div class="message-avatar assistant-avatar">${getModeIcon(mode)}</div>
                <div class="message-content">
                    <div class="loading-indicator">
                        <span class="loading-dot"></span>
                        <span class="loading-dot"></span>
                        <span class="loading-dot"></span>
                        <span class="loading-text">${modeText}</span>
                    </div>
                </div>
            `;
            container.appendChild(loadingEl);
            scrollToBottom();
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loading-message');
            if (loading) loading.remove();
        }

        function appendErrorMessage(error) {
            const container = document.getElementById('chat-container');
            const messageEl = document.createElement('div');
            messageEl.className = 'message error-message';
            messageEl.innerHTML = `
                <div class="message-avatar error-avatar">‚ö†Ô∏è</div>
                <div class="message-content">
                    <div class="message-text">Error: ${escapeHtml(error)}</div>
                </div>
            `;
            container.appendChild(messageEl);
            scrollToBottom();
        }

        function highlightChosenModel(modelName) {
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('chosen'));
            const chosenEl = document.querySelector(`.model-item[data-model="${modelName}"]`);
            if (chosenEl) chosenEl.classList.add('chosen');
        }

        function highlightCommand(command) {
            document.querySelectorAll('.command-item').forEach(el => el.classList.remove('active'));
            if (command) {
                const cmdEl = document.querySelector(`.command-item[data-command="${command}"]`);
                if (cmdEl) cmdEl.classList.add('active');
            }
        }

        // =============================================================================
        // Event Handlers
        // =============================================================================
        
        async function handleSubmit(event) {
            event.preventDefault();
            if (isLoading) return;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return;
            
            const useRag = document.getElementById('use-rag').checked;
            
            // Detect mode from message
            let mode = 'normal';
            if (message.startsWith('/research')) mode = 'research';
            else if (message.startsWith('/deepthinking')) mode = 'deepthinking';
            else if (message.startsWith('/swarm')) mode = 'swarm';
            else if (message.startsWith('/code')) mode = 'code';
            
            input.value = '';
            resetTextareaHeight();
            hideInputHints();
            appendUserMessage(message);
            highlightCommand(mode !== 'normal' ? mode : null);
            
            isLoading = true;
            updateSendButton(true);
            appendLoadingMessage(mode);
            
            try {
                const data = await sendMessage(message, useRag);
                removeLoadingMessage();
                appendAssistantMessage(data);
            } catch (error) {
                removeLoadingMessage();
                appendErrorMessage(error.message);
            } finally {
                isLoading = false;
                updateSendButton(false);
                highlightCommand(null);
            }
        }

        function insertCommand(command) {
            const input = document.getElementById('message-input');
            input.value = `/${command} `;
            input.focus();
            showInputHints(command);
        }

        function clearChat() {
            const container = document.getElementById('chat-container');
            container.innerHTML = `
                <div class="welcome-message" id="welcome-message">
                    <div class="welcome-icon">ü§ñ</div>
                    <h2>Welcome to ChatOS</h2>
                    <p>Start a conversation with your local AI council.</p>
                </div>
            `;
            document.querySelectorAll('.model-item').forEach(el => el.classList.remove('chosen'));
        }

        // =============================================================================
        // Utilities
        // =============================================================================
        
        function setupTextarea() {
            const textarea = document.getElementById('message-input');
            
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
                
                // Check for command hints
                const value = textarea.value;
                if (value.startsWith('/')) {
                    const cmd = value.slice(1).split(' ')[0];
                    showInputHints(cmd);
                } else {
                    hideInputHints();
                }
            });
            
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
                }
                if (e.key === 'Escape') {
                    textarea.value = '';
                    resetTextareaHeight();
                    hideInputHints();
                }
            });
        }

        function showInputHints(command) {
            const hints = document.getElementById('input-hints');
            const hintText = {
                'research': 'üî¨ Research: Add your query to search the web for context',
                'deepthinking': 'üß† Deep Thinking: Add a problem to analyze with extended reasoning',
                'swarm': 'üêù Swarm: Describe a coding task for multi-agent collaboration',
                'code': '‚å®Ô∏è Code: Add your coding request',
            }[command];
            
            if (hintText) {
                hints.textContent = hintText;
                hints.style.display = 'block';
            } else {
                hints.style.display = 'none';
            }
        }

        function hideInputHints() {
            document.getElementById('input-hints').style.display = 'none';
        }

        function resetTextareaHeight() {
            const textarea = document.getElementById('message-input');
            textarea.style.height = 'auto';
        }

        function updateSendButton(loading) {
            const button = document.getElementById('send-button');
            if (loading) {
                button.disabled = true;
                button.innerHTML = '<span class="send-icon spinning">‚Üª</span>';
            } else {
                button.disabled = false;
                button.innerHTML = '<span class="send-icon">‚û§</span>';
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatResponse(text) {
            let formatted = escapeHtml(text);
            
            // Convert markdown headers
            formatted = formatted.replace(/^### (.+)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^# (.+)$/gm, '<h2>$1</h2>');
            
            // Convert bold
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert code blocks
            formatted = formatted.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre class="code-block"><code class="language-${lang || 'plaintext'}">${code.trim()}</code></pre>`;
            });
            
            // Convert inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
            
            // Convert bullet points
            formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            
            // Convert checkboxes
            formatted = formatted.replace(/\[x\]/g, '‚úÖ');
            formatted = formatted.replace(/\[ \]/g, '‚¨ú');
            
            // Convert line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
    </script>
</body>
</html>
