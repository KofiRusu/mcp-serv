#!/bin/bash
# High-Frequency Paper Trading CLI
# Cross-platform support for Linux and macOS
# Usage: hf-trading [command]

set -e

# Detect platform
if [[ "$OSTYPE" == "darwin"* ]]; then
    IS_MAC=true
    HOME_DIR="$HOME"
    PERSRM_DIR="$HOME/persrm-distillation"
    VENV_ACTIVATE="$HOME/venv/bin/activate"
else
    IS_MAC=false
    HOME_DIR="/home/kr"
    PERSRM_DIR="/home/kr/persrm-distillation"
    VENV_ACTIVATE="/home/kr/text-generation-webui/venv/bin/activate"
fi

COMPOSE_FILE="$PERSRM_DIR/docker-compose.hf-trading.yml"
LOG_DIR="$HOME_DIR/TradingMemory/logs/hf_trading"
DATA_DIR="$HOME_DIR/TradingMemory/data/hf_trading"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

show_help() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘       High-Frequency Paper Trading System CLI           â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    if $IS_MAC; then
        echo -e "  Platform: ${YELLOW}macOS${NC}"
    else
        echo -e "  Platform: ${YELLOW}Linux${NC}"
    fi
    echo ""
    echo -e "${GREEN}Commands:${NC}"
    echo -e "  ${YELLOW}start${NC}       - Start HF trading system (Docker)"
    echo -e "  ${YELLOW}stop${NC}        - Stop all HF trading services"
    echo -e "  ${YELLOW}status${NC}      - Show service status"
    echo -e "  ${YELLOW}logs${NC}        - View live trading logs"
    echo -e "  ${YELLOW}accuracy${NC}    - Show accuracy dashboard"
    echo -e "  ${YELLOW}trades${NC}      - Show recent trades"
    echo -e "  ${YELLOW}signals${NC}     - Show recent signals"
    echo -e "  ${YELLOW}performance${NC} - Show performance metrics"
    echo -e "  ${YELLOW}local${NC}       - Run locally (no Docker)"
    echo -e "  ${YELLOW}help${NC}        - Show this help"
    echo ""
}

ensure_dirs() {
    mkdir -p "$LOG_DIR" "$DATA_DIR"
}

start_docker() {
    ensure_dirs
    echo -e "${CYAN}ðŸš€ Starting HF Paper Trading System...${NC}"
    cd "$PERSRM_DIR"
    
    if [ -f "$COMPOSE_FILE" ]; then
        docker-compose -f docker-compose.hf-trading.yml up -d
        echo -e "${GREEN}âœ“ HF Trading System started!${NC}"
        echo ""
        docker-compose -f docker-compose.hf-trading.yml ps
    else
        echo -e "${RED}Docker compose file not found: $COMPOSE_FILE${NC}"
        echo -e "${YELLOW}Try: hf-trading local${NC}"
    fi
}

stop_docker() {
    echo -e "${YELLOW}ðŸ›‘ Stopping HF Paper Trading System...${NC}"
    
    # Stop local processes
    pkill -f "hf_paper_trader" 2>/dev/null || true
    pkill -f "accuracy_tracker" 2>/dev/null || true
    
    # Stop Docker
    if [ -f "$COMPOSE_FILE" ]; then
        cd "$PERSRM_DIR"
        docker-compose -f docker-compose.hf-trading.yml down 2>/dev/null || true
    fi
    
    echo -e "${GREEN}âœ“ All HF services stopped.${NC}"
}

show_status() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘            HF Trading System Status                     â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    if $IS_MAC; then
        echo -e "  Platform: ${YELLOW}macOS${NC}"
    else
        echo -e "  Platform: ${YELLOW}Linux${NC}"
    fi
    echo ""
    
    # Docker status
    echo -e "${YELLOW}ðŸ“¦ Docker Services:${NC}"
    if [ -f "$COMPOSE_FILE" ]; then
        cd "$PERSRM_DIR"
        docker-compose -f docker-compose.hf-trading.yml ps 2>/dev/null || echo "  (Docker services not running)"
    else
        echo "  (Docker compose file not found)"
    fi
    echo ""
    
    # Local process status
    echo -e "${YELLOW}ðŸ”„ Local Processes:${NC}"
    if pgrep -f "hf_paper_trader" > /dev/null 2>&1; then
        echo -e "  HF Trader: ${GREEN}â— Running${NC}"
    else
        echo -e "  HF Trader: ${RED}â—‹ Not running${NC}"
    fi
    
    if pgrep -f "accuracy_tracker" > /dev/null 2>&1; then
        echo -e "  Accuracy Tracker: ${GREEN}â— Running${NC}"
    else
        echo -e "  Accuracy Tracker: ${RED}â—‹ Not running${NC}"
    fi
    echo ""
    
    # Latest state
    if [ -f "$DATA_DIR/hf_state_latest.json" ]; then
        echo -e "${YELLOW}ðŸ“Š Latest State:${NC}"
        python3 -c "
import json
with open('$DATA_DIR/hf_state_latest.json') as f:
    state = json.load(f)
print(f'  Balance: \${state.get(\"balance\", 0):,.2f}')
print(f'  Equity: \${state.get(\"equity\", 0):,.2f}')
print(f'  Total Trades: {state.get(\"total_trades\", 0)}')
print(f'  Win Rate: {state.get(\"win_rate\", 0)*100:.1f}%')
" 2>/dev/null || echo "  (Unable to parse state file)"
    else
        echo "  ${YELLOW}No state file found yet${NC}"
    fi
}

show_logs() {
    echo -e "${CYAN}ðŸ“ Live Trading Logs (Ctrl+C to exit)${NC}"
    echo ""
    
    if [ -f "$LOG_DIR/hf_trader.log" ]; then
        tail -f "$LOG_DIR/hf_trader.log"
    elif [ -f "$COMPOSE_FILE" ]; then
        # Check Docker logs
        cd "$PERSRM_DIR"
        docker-compose -f docker-compose.hf-trading.yml logs -f hf-paper-trader 2>/dev/null || \
            echo "No logs found. Start the trading system first."
    else
        echo "No logs found. Start the trading system first."
        echo "  Try: hf-trading local"
        echo "  Or:  hf-trading start"
    fi
}

show_accuracy() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘              Accuracy Dashboard                         â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    cd "$PERSRM_DIR"
    if [ -f "$VENV_ACTIVATE" ]; then
        source "$VENV_ACTIVATE" 2>/dev/null
    fi
    python3 -c "
from accuracy_tracker import AccuracyTracker
tracker = AccuracyTracker()
tracker.print_dashboard()
" 2>/dev/null || echo "Failed to load accuracy tracker"
}

show_trades() {
    echo -e "${CYAN}ðŸ“ˆ Recent Trades${NC}"
    echo ""
    
    if [ -f "$DATA_DIR/trades_latest.json" ]; then
        python3 -c "
import json
with open('$DATA_DIR/trades_latest.json') as f:
    trades = json.load(f)
for t in trades[-10:]:
    side = 'ðŸŸ¢ BUY' if t.get('side') == 'buy' else 'ðŸ”´ SELL'
    pnl = t.get('pnl', 0)
    pnl_color = 'âœ…' if pnl >= 0 else 'âŒ'
    print(f\"{side} {t.get('symbol', 'N/A')} @ \${t.get('price', 0):.2f} | PnL: \${pnl:.2f} {pnl_color}\")
" 2>/dev/null || echo "No trades found"
    else
        echo "No trade data available yet."
    fi
}

show_signals() {
    echo -e "${CYAN}ðŸ“¡ Recent Signals${NC}"
    echo ""
    
    if [ -f "$DATA_DIR/signals_latest.json" ]; then
        python3 -c "
import json
with open('$DATA_DIR/signals_latest.json') as f:
    signals = json.load(f)
for s in signals[-10:]:
    signal_type = s.get('type', 'HOLD')
    icon = 'ðŸŸ¢' if signal_type == 'BUY' else ('ðŸ”´' if signal_type == 'SELL' else 'âšª')
    print(f\"{icon} {signal_type} | Confidence: {s.get('confidence', 0)*100:.0f}% | Reason: {s.get('reason', 'N/A')}\")
" 2>/dev/null || echo "No signals found"
    else
        echo "No signal data available yet."
    fi
}

show_performance() {
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘            Performance Metrics                          â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    cd "$PERSRM_DIR"
    if [ -f "$VENV_ACTIVATE" ]; then
        source "$VENV_ACTIVATE" 2>/dev/null
    fi
    python3 -c "
import json
from pathlib import Path

data_dir = Path('$DATA_DIR')
state_file = data_dir / 'hf_state_latest.json'
accuracy_file = Path('$HOME_DIR/TradingMemory/accuracy/accuracy_metrics.json')

if state_file.exists():
    with open(state_file) as f:
        state = json.load(f)
    print('ðŸ“Š Trading Performance:')
    print(f'  Initial Balance: \${state.get(\"initial_balance\", 10000):,.2f}')
    print(f'  Current Equity: \${state.get(\"equity\", 0):,.2f}')
    pnl_pct = (state.get('equity', 0) - state.get('initial_balance', 10000)) / state.get('initial_balance', 10000) * 100
    print(f'  Return: {pnl_pct:+.2f}%')
    print(f'  Win Rate: {state.get(\"win_rate\", 0)*100:.1f}%')
    print(f'  Total Trades: {state.get(\"total_trades\", 0)}')
    print()
else:
    print('No trading state data yet')

if accuracy_file.exists():
    with open(accuracy_file) as f:
        acc = json.load(f)
    print('ðŸŽ¯ Accuracy Metrics:')
    print(f'  Signal Accuracy: {acc.get(\"signal_accuracy\", 0)*100:.1f}%')
    print(f'  Entry Timing: {acc.get(\"entry_timing\", 0)*100:.1f}%')
    print(f'  Risk Management: {acc.get(\"risk_accuracy\", 0)*100:.1f}%')
else:
    print('No accuracy data yet')
" 2>/dev/null || echo "Failed to load performance data"
}

run_local() {
    ensure_dirs
    echo -e "${CYAN}ðŸš€ Starting HF Trading Locally...${NC}"
    cd "$PERSRM_DIR"
    
    if [ -f "$VENV_ACTIVATE" ]; then
        source "$VENV_ACTIVATE"
    fi
    
    nohup python3 hf_paper_trader.py --interval 15 --symbols BTC/USDT,ETH/USDT,SOL/USDT \
        > "$LOG_DIR/hf_trader.log" 2>&1 &
    
    echo -e "${GREEN}âœ“ HF Trading started locally (PID: $!)${NC}"
    echo -e "  View logs: ${YELLOW}hf-trading logs${NC}"
}

# Main command handler
case "${1:-help}" in
    start)
        start_docker
        ;;
    stop)
        stop_docker
        ;;
    status)
        show_status
        ;;
    logs)
        show_logs
        ;;
    accuracy)
        show_accuracy
        ;;
    trades)
        show_trades
        ;;
    signals)
        show_signals
        ;;
    performance)
        show_performance
        ;;
    local)
        run_local
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
