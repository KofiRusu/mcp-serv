# ChatOS Reverse Proxy Configuration
# Copy this file to /etc/caddy/Caddyfile and update the domain name
#
# Installation:
#   sudo cp Caddyfile /etc/caddy/Caddyfile
#   sudo caddy validate --config /etc/caddy/Caddyfile
#   sudo systemctl restart caddy

# Replace 'chatos.yourdomain.com' with your actual domain
chatos.yourdomain.com {

    # UI -> Next.js (everything not matching /api or /ws goes to UI)
    reverse_proxy / localhost:3000

    # API -> FastAPI (everything under /api goes to backend)
    reverse_proxy /api/* localhost:8000

    # WebSocket support for realtime data and terminal
    # Route /api/v1/realtime/ws through to backend
    reverse_proxy /api/v1/realtime/ws localhost:8000 {
        header_up Connection "Upgrade"
        header_up Upgrade "websocket"
    }

    # WebSocket support for automation output streams
    reverse_proxy /api/v1/automations/*/ws/* localhost:8000 {
        header_up Connection "Upgrade"
        header_up Upgrade "websocket"
    }

    # WebSocket support for terminal
    reverse_proxy /api/terminal/ws/* localhost:8000 {
        header_up Connection "Upgrade"
        header_up Upgrade "websocket"
    }

    # Keycloak authentication proxy (uncomment if using Keycloak)
    # reverse_proxy /auth/* localhost:8080

    # Proxy headers for correct URL building and authentication
    header {
        X-Forwarded-Proto {scheme}
        X-Forwarded-Host {host}
        X-Real-IP {remote_host}
    }

    # Optional: Basic auth for beta testers (uncomment and configure)
    # basicauth {
    #   tester <HASH_FROM_caddy_hash-password>
    # }
}

# Alternative: Use IP address if no domain (for testing only)
# Replace with your server's public IP
# :443 {
#     tls self_signed
#     reverse_proxy / localhost:3000
#     reverse_proxy /api/* localhost:8000
#     reverse_proxy /api/v1/realtime/ws localhost:8000 {
#         header_up Connection "Upgrade"
#         header_up Upgrade "websocket"
#     }
#     reverse_proxy /api/v1/automations/*/ws/* localhost:8000 {
#         header_up Connection "Upgrade"
#         header_up Upgrade "websocket"
#     }
#     reverse_proxy /api/terminal/ws/* localhost:8000 {
#         header_up Connection "Upgrade"
#         header_up Upgrade "websocket"
#     }
#     header {
#         X-Forwarded-Proto {scheme}
#         X-Forwarded-Host {host}
#         X-Real-IP {remote_host}
#     }
# }
